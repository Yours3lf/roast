<html>
<style>
    body {
        background-color: #EBECF0;
        margin-top: 20px;
        margin-left: 10px;
        font-family: Verdana;
        -webkit-tap-highlight-color: transparent;
        text-shadow: 1px 1px white;
        color: #676767;
    }

    .checkbox{
        display: block;
        background: white;
        width: 10px;
        height: 10px;
        border: 1px inset;
        border-radius: 3px;
    }

    .checkmark{
        font-size: 10px;
        position: relative;
        top: -2px;
        left: 2px;
        visibility: hidden;
    }

    .timeInput {
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #fff;
        border-radius: 30px;
        border: 0;
        height: 30px;
        padding-left: 16px;
        padding-right: 16px;
        margin-right: 5px;
        outline: 0;
        background-color: #EBECF0;
        transition: all 0.2s ease-in-out;
    }

    .timeInput:focus-within {
        box-shadow: inset 1px 1px 2px #babecc, inset -1px -1px 2px #fff
    }

    .timeInput > input {
        border: none;
        outline: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
        background: transparent;
        width: 16px;
        color: #676767;
        font-family: Verdana;
        text-align: center;
    }

    .timeInput > input:focus{
        box-shadow: none;
    }

    #phaseContainer {
        display: flex;
        flex-direction: row;
        width: 1430px;
        margin-left: 80px;
        margin-top: 20px;
        justify-content: space-evenly;
        font-size: 13px;
    }

    #phaseContainer > div{
        display: flex;
        flex-direction: column;
    }

    #offlineText {
        position: relative;
        top: -150px;
        height: 0;
        font-size: 20px;
        width: 100%;
        text-align: center;
    }

    #thermalCamTooltip{
        visibility: hidden;
        background: rgba(255 255 255 / 53%);
        margin-left: 15px;
        z-index: 999999;
        position:absolute;
        padding: 5px;
        border-radius: 10px;
    }

    .lineChartHover {
        visibility: hidden;
        z-index: 999999;
        position: absolute;
        margin-left: 15px;
        display: flex;
    }

    .lineChartHoverText {
        background: rgba(255 255 255 / 53%);
        padding: 5px;
        border-radius: 10px;
    }

    #lineChartVerticalIndicator {
        visibility: hidden;
        z-index: 999999;
        position: absolute;
        margin-left: -5px;
        display: block;
        background: #bebebe;
        height: 720px;
        width: 2px;
        top: 70px;
    }

    #lineChartHorizontalIndicator {
        visibility: hidden;
        z-index: 999999;
        position: absolute;
        margin-top: -5px;
        display: block;
        background: #bebebe;
        height: 2px;
        width: 1302px;
        left: 164px;
    }

    #beanTemperatureProjection {
        z-index: 99999;
        position: absolute;
        display: block;
        height: 500px;
        width: 2px;
        background: repeating-linear-gradient( 0deg, transparent, transparent 10px, #ccc 10px, #ccc 20px );
        visibility: hidden;
    }

    .propertySectionTitle {
        width: 100%;
        display: block;
        margin-bottom: 3px;
        margin-top: 10px;
        text-align: center;
        color: #9397a4;
        font-weight: bold;
    }

    #propertiesInputForm{
        display: flex;
        flex-direction: column;
    }

    #propertiesInputForm > div{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .filePickerInput {
        background-image: url('img/file.png');
        background-repeat: no-repeat;
        background-size: 20px;
        padding-left: 40px;
        background-position: 16px 5px;
        cursor: pointer;
    }

    input {
        margin: 5px;
        width: 220px;
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #fff;
        border-radius: 30px;
        border: 0;
        height: 30px;
        padding-left: 16px;
        outline: 0;
        background-color: #EBECF0;
        transition: all 0.2s ease-in-out;
    }

    input:focus {
        box-shadow: inset 1px 1px 2px #babecc, inset -1px -1px 2px #fff
    }

    input:disabled {
        box-shadow: none;
        border: 1px solid #bebebe;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }

    #actions{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        margin-right: 10px;
    }

    .actionButton{
        text-align: center;
        width: 50px;
        height: 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 13px;
    }

    #backgroundBlur {
        position: fixed;
        backdrop-filter: blur(5px);
        /*backdrop-filter: brightness(40%);*/
        z-index: 999;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }

    .textBox {
        width: 97%;
        height: 100px;
        overflow-x: hidden;
        overflow-y: scroll;
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #fff;
        border-radius: 10px;
        border: 0;
        padding-left: 15px;
        outline: 0;
        background-color: #ececec;
        padding-top: 10px;
        font-size: 13px;
        margin-left: 5px;
        padding-bottom: 10px;
        text-shadow: 1px 1px white;
        color: #676767;
        font-family: Verdana;
    }

    .textBox::-webkit-scrollbar {
        width: 20px;
    }

    .textBox::-webkit-scrollbar-track {
    }

    .textBox::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background: #babecc;
        border: 1px solid #9b9b9b;
    }

    .textBox::-webkit-scrollbar-thumb:hover {
        background: #a9adbb;
    }

    .textBox::-webkit-scrollbar-thumb:active {
        background: #989caa;
    }

    textarea {
        resize: none;
    }

    textarea:focus{
        outline: none;
    }

    #propertiesIcon {
        opacity: 0.5;
        cursor: pointer;
        transition: transform 0.5s;
        padding: 5px;
    }

    #propertiesIcon:hover {
        transform: rotate(90deg);
    }

    #propertiesIcon:active{
        opacity: 0.75;
    }

    #propertiesDialog {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        margin: 2% auto;
        width: 700px;
        padding: 20px;
        border-radius: 20px;
        box-shadow: -5px -5px 20px #b0b0b0, 5px 5px 20px black;
        background-color: #EBECF0;
        visibility: hidden;
        z-index: 99999;
    }

    #propertiesTitle {
        width: 100%;
        display: block;
        text-align: center;
        margin-bottom: 10px;
        color: #9397a4;
        font-weight: bold;
        font-size: 1.5em;
    }

    .button {
        border: 0;
        outline: 0;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        transition: all 0.2s ease-in-out;
        padding: 5px 8px 5px 8px;
        text-decoration: none;
        cursor: pointer;
        
        font-weight: bold;
        user-select: none;
    }

    .button:hover {
        box-shadow: -2px -2px 5px #fff, 2px 2px 5px #babecc;
    }

    .button:active {
        box-shadow: inset 1px 1px 2px #babecc, inset -1px -1px 2px #fff;
    }

    .disabledStyle, .disabledElement {
        box-shadow: none !important;
        border: 1px solid #bebebe !important;
        transition: all 0.35s ease-in-out 0.01s;
    }

    .disabledElement {
        pointer-events: none !important;
    }

    .closeButton {
        position: absolute;
        right: 15px;
        top: 12px;
    }

    .lineChart {
        margin: 0px 10px 0px 10px;
        padding: 10px;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
    }

    .thermalCam {
        width: 320px;
        height: 240px;
        background-color: grey;
        vertical-align: top;
        margin: 0px 10px 20px 10px;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        background-image: url(img/noise.png);
    }

    .controller {
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        border-radius: 20px;
        background-color: #d1d4e0;
        width: 60px;
        height: 320px;
        display: flex;
        margin: 10px;
        user-select: none;
        transition: all 0.2s ease-in-out;
    }

    .controller:hover {
        box-shadow: -2px -2px 5px #fff, 2px 2px 5px #babecc;
        cursor: pointer;
    }

    .controller > span {
        width: inherit;
        background-color: #ebecf0;
        background-size: 100% 100%;
        display: block;
        border-radius: 20px;
        align-self: flex-end;
    }

    .controller > span > span {
        display: flex;
        height: 100%;
        color: #555;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        position: relative;
        bottom: 15px;
    }

    #fanImage {
        opacity: 0.75;
        animation: spin 1.35s linear infinite;
    }

    @keyframes spin 
    {
        100% 
        {
            transform: rotate(360deg);
        }
    }
</style>
<body  oncontextmenu="return false;">
    <!--
    Roast properties:
        date time, roast name, blend, individual bean types, batch, weights, volumes,
        density calculation, moisture, bean screen size, ambient temp/humidity/pressure,
        end weight, end volume, end density
    -->
    <div id="propertiesDialog">
        <span class="closeButton button" onclick="hideRoastProperties();">X</span>
        <span id="propertiesTitle">Roast Properties</span>
        <div id="propertiesInputForm">
            <div>
                <input type="text" id="roastName" placeholder="Roast Name" title="Roast Name" onchange="roastProfile.setName(event.target.value)" />
                <input type="date" readonly="readonly" disabled id="roastDate" title="Roast Date (auto filled)" />
                <input type="time" readonly="readonly" disabled id="roastTime" title="Roast Time (auto filled)" />
            </div>
            <div>
                <input type="number" readonly="readonly" disabled placeholder="Temperature (°C)" title="Temperature (°C)" id="ambientTemperature" />
                <input type="number" readonly="readonly" disabled placeholder="Humidity (%)" title="Humidity (%)" id="ambientHumidity" />
                <input type="number" readonly="readonly" disabled placeholder="Pressure (atm)" title="Pressure (atm)" id="ambientPressure" />
            </div>
            <span class="propertySectionTitle">Pre Roast Bean Data</span>
            <div>
                <input type="text" id="beanType" placeholder="Bean Type" title="Bean Type" onchange="roastProfile.setBeanType(event.target.value)" />
                <input type="number" id="moistureContent" placeholder="Moisture Content (%)" title="Moisture Content (%)" onchange="roastProfile.setMoistureContent(event.target.value)" />
                <input type="number" id="beanScreenSize" placeholder='Bean Screen Size (1/64")' title='Bean Screen Size (1/64")' onchange="roastProfile.setBeanScreenSize(event.target.value)" />
            </div>
            <div>
                <input type="number" id="beanWeight" placeholder="Bean Weight (g)" title="Bean Weight (g)" onchange="roastProfile.setWeight(event.target.value)" />
                <input type="number" id="beanVolume" placeholder="Bean Volume (mL)" title="Bean Volume (mL)" onchange="roastProfile.setVolume(event.target.value)" />
                <input type="number" id="beanDensity" placeholder="Density (g/mL)" title="Density (g/mL)" onchange="roastProfile.setDensity(event.target.value)" />
            </div>
            <span class="propertySectionTitle">Post Roast Bean Data</span>
            <div>
                <input type="number" id="endBeanWeight" placeholder="End Weight (g)" title="End Weight (g)" onchange="roastProfile.setEndWeight(event.target.value)" />
                <input type="number" id="endBeanVolume" placeholder="End Volume (mL)" title="End Volume (mL)" onchange="roastProfile.setEndVolume(event.target.value)" />
                <input type="number" id="endBeanDensity" placeholder="End Density (g/mL)" title="End Density (g/mL)" onchange="roastProfile.setEndDensity(event.target.value)" />
            </div>
            <div>
                <input type="number" readonly="readonly" disabled id="weightLossPercentage" placeholder="Weight loss (%)" title="Weight loss (%)" />
                <input type="number" readonly="readonly" disabled id="volumeGainPercentage" placeholder="Volume gain (%)" title="Volume gain (%)" />
                <input type="number" id="groundsColourIndex" placeholder="Grounds Colour Index" title="Grounds Colour Index" onchange="roastProfile.setColourIndex(event.target.value)" />
            </div>
        </div>
        <span class="propertySectionTitle">Roasting Notes</span>
        <textarea id="roastingNotes" class="textBox" style="width:99%;" placeholder="Roasting and cupping notes" onchange="roastProfile.setRoastingNotes(event.target.value)"></textarea>
        <span class="propertySectionTitle">Event timing</span>
        <div style="display: flex; flex-direction: row; flex-wrap: wrap; align-items: center; justify-content: space-evenly;">
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">CHG</span>
                <div class="timeInput">
                    <input type="number" id="chgMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'CHG')" placeholder="m" maxlength="2" />:<input type="number" id="chgSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'CHG')" placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">DE</span>
                <div class="timeInput">
                    <input type="number" id="deMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'DE')" placeholder="m" maxlength="2" />:<input type="number" id="deSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'DE')" placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">FCS</span>
                <div class="timeInput">
                    <input type="number" id="fcsMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'FCS')"  placeholder="m" maxlength="2" />:<input type="number" id="fcsSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'FCS')"  placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">FCE</span>
                <div class="timeInput">
                    <input type="number" id="fceMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'FCE')" placeholder="m" maxlength="2" />:<input type="number" id="fceSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'FCE')" placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">SCS</span>
                <div class="timeInput">
                    <input type="number" id="scsMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'SCS')" placeholder="m" maxlength="2" />:<input type="number" id="scsSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'SCS')" placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">SCE</span>
                <div class="timeInput">
                    <input type="number" id="sceMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'SCE')" placeholder="m" maxlength="2" />:<input type="number" id="sceSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'SCE')" placeholder="s" maxlength="2" />
                </div>
            </div>
            <div style="display:flex; flex-direction: column; align-items:center;">
                <span style="margin-bottom: 3px;">COOL</span>
                <div class="timeInput">
                    <input type="number" id="coolMin" onchange="roastProfile.setEventTimeMin(event.target.value, 'COOL')" placeholder="m" maxlength="2" />:<input type="number" id="coolSec" onchange="roastProfile.setEventTimeSec(event.target.value, 'COOL')" placeholder="s" maxlength="2" />
                </div>
            </div>
        </div>
        <span class="propertySectionTitle">Roast Profile Management</span>
        <div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center;">
            <div style="width:49%; display:flex; flex-direction: row; justify-content: space-evenly; align-items:center;">
                <!--We'll be able to read/write a file using this.files[0] here-->
                <span class="button" onclick="loadRoastProfile()">Load</span>
                <!--Icons created by Kiranshastry - Flaticon-->
                <input type="text" placeholder="Filename" readonly="readonly" class="filePickerInput" onclick="document.getElementById('filePicker').click();" style="width:75%;" id="fileLoadPath" />
                <input type="file" id="filePicker" accept=".json" style="display:none;" onchange="document.getElementById('fileLoadPath').value = this.files[0].name; fileToLoad = this.files[0];" />
            </div>
            <div style="min-width:2%;height:1px;"></div>
            <div style="width:49%; display:flex; flex-direction: row; justify-content: space-evenly; align-items:center;">
                <input type="text" placeholder="Filename" readonly="readonly" class="filePickerInput" onclick="pickSaveFile()" style="width: 75%; text-align: right; padding-right: 16px;" id="fileSavePath" />
                <!--Icons created by Kiranshastry - Flaticon-->
                <span class="button" onclick="saveRoastProfile()">Save</span>
            </div>
        </div>
        <span class="propertySectionTitle">Connection settings</span>
        <div style="margin-top: 0px; margin-bottom: 5px; ">
            <input type="text" id="wsAddress" placeholder="Websocket address: ws://xxx.xxx.xxx.xxx:xxxxx" style=" width: 350px; margin-right: 10px; " />
            <span id="connectButton" class="button" onclick="connect()" style="margin-right:10px;">Connect</span>
            <span id="disconnectButton" class="button disabledElement" onclick="disconnect()">Disconnect</span>
        </div>
        <div id="websocketMessages" class="textBox" style="height:60px;"></div>
    </div>

    <div id="backgroundBlur"></div>

    <div style="display: flex; flex-direction: row;">
        <div id="actions">
            <div class="button actionButton" onclick="showRoastProperties();" title="Start Roasting (Drying Phase Start)">
                <img src="img/properties.png" width="40" id="propertiesIcon" />
                <!--Icon created by Freepik - Flaticon-->
            </div>

            <div id="startButton" class="button actionButton" onclick="roastProfile.setStart();" title="Start Roasting">
                <span>START</span>
            </div>

            <div id="chargeButton" class="button actionButton" onclick="roastProfile.setCharge();" title="Charge beans (Drying Phase Start)">
                <span>CHG</span>
            </div>

            <div id="dryEndButton" class="button actionButton" onclick="roastProfile.setDryEnd();" title="Insert Drying Phase End Event">
                <span>DRY<br />END</span>
            </div>

            <div id="fcStartButton" class="button actionButton" onclick="roastProfile.setFirstCrackStart();" title="Insert First Crack Start Event">
                <span>FC<br />START</span>
            </div>

            <div id="fcEndButton" class="button actionButton" onclick="roastProfile.setFirstCrackEnd();" title="Insert First Crack End Event">
                <span>FC<br />END</span>
            </div>

            <div id="scStartButton" class="button actionButton" onclick="roastProfile.setSecondCrackStart();" title="Insert Second Crack Start Event">
                <span>SC<br />START</span>
            </div>

            <div id="scEndButton" class="button actionButton" onclick="roastProfile.setSecondCrackEnd();" title="Insert Second Crack End Event">
                <span>SC<br />END</span>
            </div>

            <div id="coolButton" class="button actionButton" onclick="roastProfile.setCool();" title="Start Cooldown (fan max, drum max, heater min)">
                <span>COOL</span>
            </div>

            <div id="stopButton" class="button actionButton" onclick="roastProfile.setStop();" title="Stop Roasting">
                <span>STOP</span>
            </div>

            <!--
        <div class="button actionButton" title="Replay Roast Profile">
            <img src="img/replay.png" width="40" style="opacity: 0.5; padding: 5px;" />
            <!--Icon created by Freepik - Flaticon--
        </div>
        -->
        </div>

        <canvas id="lineChart" class="lineChart">
            Your browser does not support the canvas element.
        </canvas>

        <div id="lineChartTooltip" class="lineChartHover">
            <span id="lineChartTooltipText" class="lineChartHoverText"></span>
        </div>

        <div id="lineChartTimeHover" class="lineChartHover">
            <span id="lineChartTimeHoverText" class="lineChartHoverText"></span>
        </div>

        <div id="lineChartTempHover" class="lineChartHover">
            <span id="lineChartTempHoverText" class="lineChartHoverText"></span>
        </div>

        <div id="lineChartRorHover" class="lineChartHover">
            <span id="lineChartRorHoverText" class="lineChartHoverText"></span>
        </div>

        <div id="lineChartVerticalIndicator"></div>
        <div id="lineChartHorizontalIndicator"></div>

        <div id="beanTemperatureProjection"></div>

        <div style="display: flex; flex-direction: column;">
            <canvas id="thermalCamera" width="320" height="240" class="thermalCam">
                Your browser does not support the canvas element.
            </canvas>

            <span id="thermalCamTooltip"></span>

            <span id="offlineText">OFFLINE</span>

            <div style="display:flex; flex-direction:column; padding:10px;">
                <canvas id="thermalCamHistogram" width="300" height="150" style="border: 1px solid #bebebe; background-color: #d1d4e0"></canvas>
                <div style="display: flex; flex-direction: row; justify-content: space-around;">
                    <span id="thermalCamMin"></span>
                    <span id="thermalCamMedian"></span>
                    <span id="thermalCamMax"></span>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-around;">
                    <span>min</span>
                    <span>med</span>
                    <span>max</span>
                </div>
            </div>

            <div id="controllers" style="display: flex; flex-direction: row; justify-content: space-evenly;">
                <div id="fanController" class="controller disabledElement" title="Cooling Fan Control">
                    <span style="height: 60%;">
                        <span><img src="img/fan.png" width="30" id="fanImage" /></span>
                        <!--Icon created by Dreamstale - Flaticon-->
                    </span>
                </div>

                <div id="drumController" class="controller disabledElement" title="Drum Motor Control">
                    <span style="height: 40%;">
                        <span><img src="img/motor.png" width="50" style="opacity:0.75; rotate: 270deg;" /></span>
                        <!--Icon created by monkik - Flaticon-->
                    </span>
                </div>

                <div id="heaterController" class="controller disabledElement" title="Heater Element Control">
                    <span style="height: 10%;">
                        <span><img src="img/fire.png" width="40" style="opacity:0.75;" /></span>
                        <!--Icon created by Those Icons - Flaticon-->
                    </span>
                </div>
            </div>
        </div>
    
        <div class="checkbox" id="beanFilterMaskCheckbox" onclick="toggleBeanFilterMask()">
            <span class="checkmark">x</span>
        </div>
    </div>

    <div id="phaseContainer">
        <div>
            <span>Drying Phase</span>
            <span id="dryingPhaseTime"></span>
            <span id="dryingPhaseStat"></span>
        </div>
        <div>
            <span>Maillard Phase</span>
            <span id="maillardPhaseTime"></span>
            <span id="maillardPhaseStat"></span>
        </div>
        <div>
            <span>Development Phase</span>
            <span id="developmentPhaseTime"></span>
            <span id="developmentPhaseStat"></span>
        </div>
        <div>
            <span>Cooling Phase</span>
            <span id="coolingPhaseTime"></span>
            <span id="coolingPhaseStat"></span>
        </div>
    </div>

    <div style="display: flex; flex-direction: row; justify-content: space-evenly; width: 1160px; left: 205px; top: 30px; position: absolute;">
        <span id="auc"></span>
        <span id="ror"></span>
        <span id="bt"></span>
        <span id="airt">AirT: xx*C</span>
        <span id="ext">ExT: xx*C</span>
    </div>


    <script>
        // Heating elements:
        // afterburner 230v (2 wire)
        // quartz heater 115v each
        //
        // Motors to be controlled:
        // dc exhaust fan 12v 0.2a (2 wire)
        // dc logic board cooling fan 12v 0.2a (2 wire)
        // drum motor 16v (2 wire)
        // afterburner draw fan 230v
        // scroll / cooling fan 230v
        //
        // On/off switch:
        // light bulb 230v
        //
        // Sensors:
        // draw fan thermocouple
        // exhaust fan thermocouple
        // main chamber thermocouple
        // thermal camera 3.3v

        //https://www.wikiwand.com/en/Coffee_roasting
        //22c  unroasted
        //165c drying phase
        //196c cinnamon roast (right after first crack)
        //205c new england roast
        //210c american roast
        //219c city roast (common for speciality coffee)
        //225c full city roast (beginning of second crack)
        //230c vienna roast
        //240c french roast
        //245c italian roast

        class MovingAverage {
            #containerMA = [];
            #maxSize = 1000;
            constructor(ms) {
                this.#maxSize = ms;
            }

            ma(x) {
                this.#containerMA.push(x);

                var avg = 0;
                for (var v of this.#containerMA) {
                    avg += v;
                }
                avg /= this.#containerMA.length;

                if (this.#containerMA.length >= this.#maxSize) {
                    this.#containerMA.shift();
                }

                return avg;
            }
        } 

        class LineChart {
            #horizontalMinVal;
            #horizontalMaxVal;
            #verticalMinVal;
            #verticalMaxVal;
            #secondaryVerticalMinVal;
            #secondaryVerticalMaxVal;
            #canvasWidth;
            #canvasHeight;
            #ctx;
            #vertAxisOffsetX;

            getWidth() { return this.#canvasWidth; }
            getHeight() { return this.#canvasHeight; }

            constructor(canvas, cWidth, cHeight, hMinVal, hMaxVal, vMinVal, vMaxVal, vsMinVal, vsMaxVal) {
                var c = canvas.getContext("2d");
                var wh = scaleCanvas(canvas, c, cWidth, cHeight);
                cWidth = wh[0];
                cHeight = wh[1];
                this.#ctx = c;
                this.#canvasWidth = cWidth;
                this.#canvasHeight = cHeight;
                this.#horizontalMinVal = hMinVal;
                this.#horizontalMaxVal = hMaxVal;
                this.#verticalMinVal = vMinVal;
                this.#verticalMaxVal = vMaxVal;
                this.#vertAxisOffsetX = 0;
                this.#secondaryVerticalMinVal = vsMinVal;
                this.#secondaryVerticalMaxVal = vsMaxVal;
            }

            canvasYoffsetToVal(y) {
                y = this.#canvasHeight - y;
                var v = y - 20;
                var h = this.#canvasHeight - 40 * 2;
                var r = v / h;
                var s = r * this.#verticalMaxVal - this.#verticalMinVal;
                return s;
            }

            canvasYoffsetToValSecondaryAxis(y) {
                y = this.#canvasHeight - y;
                var v = y - 20;
                var h = this.#canvasHeight - 40 * 2;
                var r = v / h;
                var s = r * this.#secondaryVerticalMaxVal - this.#secondaryVerticalMinVal;
                return s;
            }

            valToCanvasYoffset(v) {
                var spaceAvailable = this.#canvasHeight - 40 * 2;
                return this.#canvasHeight - 40 - (v - this.#verticalMinVal) / (this.#verticalMaxVal - this.#verticalMinVal) * spaceAvailable;
            }

            valToCanvasYoffsetSecondaryAxis(v) {
                var spaceAvailable = this.#canvasHeight - 40 * 2;
                return this.#canvasHeight - 40 - (v - this.#secondaryVerticalMinVal) / (this.#secondaryVerticalMaxVal - this.#secondaryVerticalMinVal) * spaceAvailable;
            }

            #drawHorizontalLines(v, xOffset) {
                var line = new Path2D();
                var yOffset = this.valToCanvasYoffset(v);
                line.moveTo(xOffset + 15, yOffset);
                line.lineTo(this.#canvasWidth - 40, yOffset);
                this.#ctx.stroke(line);
            }

            #drawHorizontalSecondaryLines(xOffset, v) {
                var line = new Path2D();
                var yOffset = this.valToCanvasYoffsetSecondaryAxis(v);
                var chartWidth = (this.#canvasWidth - 40) - (xOffset + 15);
                line.moveTo(xOffset + 15 + chartWidth - 5, yOffset);
                line.lineTo(xOffset + 15 + chartWidth + 5, yOffset);
                this.#ctx.stroke(line);
            }

            #drawVerticalAxisText(v) {
                var lineOffsetY = this.valToCanvasYoffset(v);
                this.#ctx.fillText(v, 5, lineOffsetY + 7);
                return this.#ctx.measureText(v).width;
            }

            #drawSecondaryVerticalAxisText(xOffset, v) {
                var lineOffsetY = this.valToCanvasYoffsetSecondaryAxis(v);
                var chartWidth = (this.#canvasWidth - 40) - (xOffset + 15);
                this.#ctx.fillText(v, xOffset + 15 + chartWidth + 15, lineOffsetY + 7);
            }

            valToCanvasXoffset(v) {
                var spaceAvailable = this.#canvasWidth - 40 - (this.#vertAxisOffsetX + 20);
                return this.#vertAxisOffsetX + 20 + (v - this.#horizontalMinVal) / (this.#horizontalMaxVal - this.#horizontalMinVal) * spaceAvailable;
            }

            canvasXoffsetToVal(x) {
                var v = x - this.#vertAxisOffsetX - 20;
                var w = this.#canvasWidth - 40 - (this.#vertAxisOffsetX + 20);
                var r = v / w;
                var s = r * this.#horizontalMaxVal - this.#horizontalMinVal;
                return s;
            }

            #drawHorizontalAxisText(v) {
                var offsetX = this.valToCanvasXoffset(v);

                var textWidth = this.#ctx.measureText(v).width;

                this.#ctx.fillText(v, offsetX - textWidth / 2, this.#canvasHeight - 10);
            }

            #drawVertixalLines(v, offsetY) {
                var offsetX = this.valToCanvasXoffset(v);

                var line = new Path2D();
                line.moveTo(offsetX, this.#canvasHeight - 40 + offsetY);
                line.lineTo(offsetX, 40);
                this.#ctx.stroke(line);
            }

            drawEventLine(x, title, subtitle, subsubtitle) {
                var xPos = this.valToCanvasXoffset(x);
                this.#ctx.font = "13px Verdana";
                this.#ctx.fillText(title, xPos - this.#ctx.measureText(title).width / 2, 55);
                this.#ctx.fillText(subtitle, xPos - this.#ctx.measureText(subtitle).width / 2, 55 + 13);
                this.#ctx.fillText(subsubtitle, xPos - this.#ctx.measureText(subsubtitle).width / 2, 55 + 13 * 2);

                var line = new Path2D();
                line.moveTo(xPos, this.#canvasHeight - 40);
                line.lineTo(xPos, 50 + 3 * 13);
                this.#ctx.lineWidth = 2.0;
                this.#ctx.strokeStyle = '#676767';
                this.#ctx.stroke(line);
            }

            drawLineChartBackground(
                horizontalAxisTitleStr, verticalAxisTitleStr,
                secondaryVerticalAxisTitleStr,
                horizontalLabelArray, verticalLabelArray,
                secondaryVerticalLabelArray
            ) {
                //vertical axis title
                this.#ctx.font = "20px Verdana";
                this.#ctx.fillStyle = "#676767";
                this.#ctx.fillText(verticalAxisTitleStr, 10, 20);

                //horizontal axis title
                var horizontalAxisTextSize = this.#ctx.measureText(horizontalAxisTitleStr).width;
                this.#ctx.fillText(horizontalAxisTitleStr, this.#canvasWidth - horizontalAxisTextSize - 20, this.#canvasHeight - 10);

                this.#ctx.fillText(secondaryVerticalAxisTitleStr, this.#canvasWidth - this.#ctx.measureText(secondaryVerticalAxisTitleStr).width - 20, 20);

                //draw vertical axis texts
                for (var i of verticalLabelArray) {
                    this.#vertAxisOffsetX = Math.max(this.#vertAxisOffsetX, this.#drawVerticalAxisText(i));
                }

                //draw secondary vertical axis texts
                for (var i of secondaryVerticalLabelArray) {
                    this.#drawSecondaryVerticalAxisText(this.#vertAxisOffsetX, i);
                    this.#drawHorizontalSecondaryLines(this.#vertAxisOffsetX, i);
                }

                //draw horizontal axis texts
                for (var i of horizontalLabelArray) {
                    this.#drawHorizontalAxisText(i);
                }

                //draw horizontal lines
                this.#ctx.strokeStyle = 'rgba(0, 0, 0, 0.25)';
                this.#drawHorizontalLines(this.#verticalMinVal, this.#vertAxisOffsetX + 5);
                this.#drawHorizontalLines(this.#verticalMaxVal, this.#vertAxisOffsetX + 5);
                for (var i of verticalLabelArray) {
                    this.#drawHorizontalLines(i, this.#vertAxisOffsetX);
                }


                //draw vertical lines
                this.#drawVertixalLines(this.#horizontalMinVal, 0);
                this.#drawVertixalLines(this.#horizontalMaxVal, 0)
                for (var i of horizontalLabelArray) {
                    this.#drawVertixalLines(i, 5);
                }
            }

            drawCurveSegment(prevH, prevV, h, v, secondary = false, colour = '#676767') {
                this.#ctx.strokeStyle = colour;
                this.#ctx.lineCap = "round";
                this.#ctx.lineJoin = "round";
                this.#ctx.lineWidth = 4.0;
                var line = new Path2D();
                var xfrom = this.valToCanvasXoffset(prevH);
                var xto = this.valToCanvasXoffset(h);
                var yfrom = 0;
                var yto = 0;
                if (!secondary) {
                    yfrom = this.valToCanvasYoffset(prevV);
                    yto = this.valToCanvasYoffset(v);
                }
                else {
                    yfrom = this.valToCanvasYoffsetSecondaryAxis(prevV);
                    yto = this.valToCanvasYoffsetSecondaryAxis(v);
                }
                line.moveTo(xfrom, yfrom);
                line.lineTo(xto, yto);
                this.#ctx.stroke(line);
            }
        }

        class RoastProfile {
            #startTime = null; //in milliseconds using performance.now()
            #chargeTime = null;
            #dryEndTime = null;
            #firstCrackStartTime = null;
            #firstCrackEndTime = null;
            #secondCrackStartTime = null;
            #secondCrackEndTime = null;
            #coolTime = null
            #stopTime = null;

            #fanSettings = []; //stores pairs of (performance.now(), percentage%)
            #heaterSettings = [];
            #drumSettings = [];

            #beanTemperatures = []; //stores pairs of (performance.now(), temperature[] in C)
            #airTemperatures = [];
            #exhaustTemperatures = [];

            #name = null;
            #date = null; //JS Date()
            #beanType = null;
            #moistureContent = null; //%
            #beanScreenSize = null; //1/64"
            #weight = null; //g
            #volume = null; //mL
            #density = null; //g/mL
            #endWeight = null;
            #endVolume = null;
            #endDensity = null;
            #ambientTemperature = null;
            #ambientHumidity = null; //%
            #ambientPressure = null; //atm
            #colourIndex = null;
            #roastingNotes = null;

            #heaterLineColour = "#F09D9D";
            #drumMotorLineColour = "#F9F392";
            #fanMotorLineColour = "#A7C7E7";

            stringify() {
                return JSON.stringify(
                    {
                        '#startTime': this.#startTime,
                        '#chargeTime': this.#chargeTime,
                        '#dryEndTime': this.#dryEndTime,
                        '#firstCrackStartTime': this.#firstCrackStartTime,
                        '#firstCrackEndTime': this.#firstCrackEndTime,
                        '#secondCrackStartTime': this.#secondCrackStartTime,
                        '#secondCrackEndTime': this.#secondCrackEndTime,
                        '#coolTime': this.#coolTime,
                        '#stopTime': this.#stopTime,
                        '#fanSettings': this.#fanSettings,
                        '#heaterSettings': this.#heaterSettings,
                        '#drumSettings': this.#drumSettings,
                        '#beanTemperatures': this.#beanTemperatures,
                        '#airTemperatures': this.#airTemperatures,
                        '#exhaustTemperatures': this.#exhaustTemperatures,
                        '#name': this.#name,
                        '#date': this.#date,
                        '#beanType': this.#beanType,
                        '#moistureContent': this.#moistureContent,
                        '#beanScreenSize': this.#beanScreenSize,
                        '#weight': this.#weight,
                        '#volume': this.#volume,
                        '#density': this.#density,
                        '#endWeight': this.#endWeight,
                        '#endVolume': this.#endVolume,
                        '#endDensity': this.#endDensity,
                        '#ambientTemperature': this.#ambientTemperature,
                        '#ambientHumidity': this.#ambientHumidity,
                        '#ambientPressure': this.#ambientPressure,
                        '#colourIndex': this.#colourIndex,
                        '#roastingNotes': this.#roastingNotes,
                    }
                );
            }

            parse(s) {
                var j = JSON.parse(s);
                
                this.#startTime = j['#startTime'];
                this.#chargeTime = j['#chargeTime'];
                this.#dryEndTime = j['#dryEndTime'];
                this.#firstCrackStartTime = j['#firstCrackStartTime'];
                this.#firstCrackEndTime = j['#firstCrackEndTime'];
                this.#secondCrackStartTime = j['#secondCrackStartTime'];
                this.#secondCrackEndTime = j['#secondCrackEndTime'];
                this.#coolTime = j['#coolTime'];
                this.#stopTime = j['#stopTime'];
                this.#fanSettings = j['#fanSettings'];
                this.#heaterSettings = j['#heaterSettings'];
                this.#drumSettings = j['#drumSettings'];
                this.#beanTemperatures = j['#beanTemperatures'];
                for (var x of this.#beanTemperatures)
                {
                    x[1] = new Float32Array(Object.values(x[1]));
                }
                this.#airTemperatures = j['#airTemperatures'];
                this.#exhaustTemperatures = j['#exhaustTemperatures'];
                this.#name = j['#name'];
                this.#date = new Date(j['#date']);
                this.#beanType = j['#beanType'];
                this.#moistureContent = j['#moistureContent'];
                this.#beanScreenSize = j['#beanScreenSize'];
                this.#weight = j['#weight'];
                this.#volume = j['#volume'];
                this.#density = j['#density'];
                this.#endWeight = j['#endWeight'];
                this.#endVolume = j['#endVolume'];
                this.#endDensity = j['#endDensity'];
                this.#ambientTemperature = j['#ambientTemperature'];
                this.#ambientHumidity = j['#ambientHumidity'];
                this.#ambientPressure = j['#ambientPressure'];
                this.#colourIndex = j['#colourIndex'];
                this.#roastingNotes = j['#roastingNotes'];

                this.#updateDialog();

                for (var i = 0; i < this.#beanTemperatures.length; ++i)
                    this.#drawBeanTemperature(i, this.#beanTemperatures[i][0]);

                for (var i = 0; i < this.#fanSettings.length; ++i)
                    this.#drawSetting(this.#fanSettings, i, 0, this.#fanMotorLineColour);
                this.#drawSetting(this.#fanSettings, this.#fanSettings.length - 1, this.#stopTime, this.#fanMotorLineColour);

                for (var i = 0; i < this.#heaterSettings.length; ++i)
                    this.#drawSetting(this.#heaterSettings, i, 0, this.#heaterLineColour);
                this.#drawSetting(this.#heaterSettings, this.#heaterSettings.length - 1, this.#stopTime, this.#heaterLineColour);

                for (var i = 0; i < this.#drumSettings.length; ++i)
                    this.#drawSetting(this.#drumSettings, i, 0, this.#drumMotorLineColour);
                this.#drawSetting(this.#drumSettings, this.#drumSettings.length - 1, this.#stopTime, this.#drumMotorLineColour);

                if (this.#chargeTime != null && this.#startTime != null)
                    this.#drawEvent("CHG", this.#chargeTime);

                if (this.#dryEndTime != null && this.#startTime != null)
                    this.#drawEvent("DE", this.#dryEndTime);

                if (this.#firstCrackStartTime != null && this.#startTime != null)
                    this.#drawEvent("FCS", this.#firstCrackStartTime);

                if (this.#firstCrackEndTime != null && this.#startTime != null)
                    this.#drawEvent("FCE", this.#firstCrackEndTime);

                if (this.#secondCrackStartTime != null && this.#startTime != null)
                    this.#drawEvent("SCS", this.#secondCrackStartTime);

                if (this.#secondCrackEndTime != null && this.#startTime != null)
                    this.#drawEvent("SCE", this.#secondCrackEndTime);

                if (this.#coolTime != null && this.#startTime != null)
                    this.#drawEvent("COOL", this.#coolTime);
            }

            #calcROR(prevTime, prevTemp, currTime, currTemp) {
                var deltaTemp = Math.max(currTemp - prevTemp, 0.0);
                var deltaTime = currTime - prevTime + 0.00001;
                var ror = deltaTemp / deltaTime;

                if (ror == 0)
                    return 0;

                return ror;
            }

            #auc = 0;
            #calcAUC(prevTime, prevTemp, currTime, currTemp) {
                var threshold = 110;

                var deltaTime = currTime - prevTime + 0.00001;

                var deltaAUC = 0;

                if (currTemp > prevTemp) {
                    /*
                     *   /|  current temp
                     *  / |
                     * /--|  prev temp
                     * |  |
                     * |--|  ambient temp
                     * |  |
                     * ----  time elapsed
                     *
                     * */
                    if (currTemp > threshold) {
                        var deltaRect = Math.max(prevTemp - threshold, 0) * deltaTime;
                        var deltaTri = Math.abs(currTemp - prevTemp) * deltaTime / 2.0;
                        deltaAUC = deltaRect + deltaTri;
                        this.#auc += deltaAUC;
                    }
                }
                else {
                    /*
                     * |\    current temp
                     * | \
                     * |--\  prev temp
                     * |  |
                     * |--|  ambient temp
                     * |  |
                     * ----  time elapsed
                     *
                     * */
                    if (prevTemp > threshold) {
                        var deltaRect = Math.max(currTemp - threshold, 0) * deltaTime;
                        var deltaTri = Math.abs(currTemp - prevTemp) * deltaTime / 2.0;
                        deltaAUC = deltaRect + deltaTri;
                        this.#auc += deltaAUC;
                    }
                }

                return deltaAUC;
            }

            #updateDialog() {
                if(this.#ambientTemperature != null)
                    document.getElementById("ambientTemperature").value = this.#ambientTemperature;

                if(this.#ambientHumidity != null)
                    document.getElementById("ambientHumidity").value = this.#ambientHumidity;

                if(this.#ambientPressure != null)
                    document.getElementById("ambientPressure").value = this.#ambientPressure;

                if (this.#date != null) {
                    document.getElementById("roastDate").valueAsDate = this.#date;
                    document.getElementById("roastTime").valueAsDate = this.#date;
                }

                if (this.#name != null) 
                    document.getElementById("roastName").value = this.#name;

                if (this.#beanType != null)
                    document.getElementById("beanType").value = this.#beanType;

                if (this.#moistureContent != null)
                    document.getElementById("moistureContent").value = this.#moistureContent;

                if (this.#beanScreenSize != null)
                    document.getElementById("beanScreenSize").value = this.#beanScreenSize;

                if (this.#weight != null)
                    document.getElementById("beanWeight").value = Number.parseFloat(this.#weight).toFixed(1);

                if (this.#volume != null)
                    document.getElementById("beanVolume").value = Number.parseFloat(this.#volume).toFixed(1);

                if (this.#density != null)
                    document.getElementById("beanDensity").value = Number.parseFloat(this.#density).toFixed(2);

                if (this.#endWeight != null)
                    document.getElementById("endBeanWeight").value = Number.parseFloat(this.#endWeight).toFixed(1);

                if (this.#endVolume != null)
                    document.getElementById("endBeanVolume").value = Number.parseFloat(this.#endVolume).toFixed(1);

                if (this.#endDensity != null)
                    document.getElementById("endBeanDensity").value = Number.parseFloat(this.#endDensity).toFixed(2);

                if (this.#colourIndex != null)
                    document.getElementById("groundsColourIndex").value = this.#colourIndex;

                if (this.#roastingNotes != null)
                    document.getElementById("roastingNotes").value = this.#roastingNotes;

                if (this.#chargeTime != null)
                    this.#drawEventTime(this.#chargeTime, "chg");

                if (this.#dryEndTime != null)
                    this.#drawEventTime(this.#dryEndTime, "de");

                if (this.#firstCrackStartTime != null)
                    this.#drawEventTime(this.#firstCrackStartTime, "fcs");

                if (this.#firstCrackEndTime != null)
                    this.#drawEventTime(this.#firstCrackEndTime, "fce");

                if (this.#secondCrackStartTime != null)
                    this.#drawEventTime(this.#secondCrackStartTime, "scs");

                if (this.#secondCrackEndTime != null)
                    this.#drawEventTime(this.#secondCrackEndTime, "sce");

                if (this.#coolTime != null)
                    this.#drawEventTime(this.#coolTime, "cool");

                this.#updateWeightLoss();
                this.#updateVolumeGain();
            }

            #updateWeightLoss()
            {
                if (this.#weight != null && this.#endWeight != null)
                {
                    var weightloss = (1.0 - this.#endWeight / this.#weight) * 100.0;
                    document.getElementById("weightLossPercentage").value = weightloss.toFixed(1);
                }
            }

            #updateVolumeGain() {
                if (this.#volume != null && this.#endVolume != null) {
                    var volumegain = (this.#endVolume / this.#volume - 1) * 100.0;
                    document.getElementById("volumeGainPercentage").value = volumegain.toFixed(1);
                }
            }

            setColourIndex(v)
            {
                if (v == "" || v == 0) this.#colourIndex = null;
                else {
                    this.#colourIndex = v;
                }
            }

            setRoastingNotes(v)
            {
                if (v == "" || v == 0) this.#roastingNotes = null;
                else {
                    this.#roastingNotes = v;
                }
            }

            setStart() {
                if (this.#startTime == null) {
                    this.#startTime = performance.now();
                    this.#date = new Date();

                    this.#ambientTemperature = 24.0; //TODO read from sensor
                    this.#ambientHumidity = 50.0;
                    this.#ambientPressure = 1.0;

                    var fanPercentage = document.getElementById("fanController").firstElementChild.style.height;
                    fanPercentage = parseFloat(fanPercentage.substring(0, fanPercentage.length - 1));
                    this.setFanSpeed(fanPercentage);

                    var heaterPercentage = document.getElementById("heaterController").firstElementChild.style.height;
                    heaterPercentage = parseFloat(heaterPercentage.substring(0, heaterPercentage.length - 1));
                    this.setHeaterSpeed(heaterPercentage);

                    var drumPercentage = document.getElementById("drumController").firstElementChild.style.height;
                    drumPercentage = parseFloat(drumPercentage.substring(0, drumPercentage.length - 1));
                    this.setDrumSpeed(drumPercentage);

                    this.#updateDialog();

                    document.getElementById("startButton").classList.add('disabledElement');

                    document.getElementById("beanTemperatureProjection").style.visibility = "visible";

                    //for dev purposes
                    //dummyData(0);
                }
            }

            #drawEvent(str, inputTime) {
                var i = 1;
                for (; i < this.#beanTemperatures.length; ++i) {
                    if (this.#beanTemperatures[i][0] > inputTime) break;
                }
                var time = (inputTime - this.#startTime) / 60000;
                lineChart.drawEventLine(time, str, Math.floor(time) + ":" + (time * 60 - Math.floor(time) * 60).toFixed(0), this.#calcAvgBeanTemperature(i-1)/*this.#beanTemperatures[i - 1][1]*/.toFixed(1) + "°C");
            }

            setCharge() {
                if (this.#chargeTime == null && this.#startTime != null && this.#stopTime == null) {
                    this.#chargeTime = performance.now();
                    this.#drawEvent("CHG", this.#chargeTime);
                    document.getElementById("chargeButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#chargeTime, "chg");
                }
            }

            setEventTimeMin(v, n)
            {
                if (v == "" || v == 0) return;

                var time = null;

                switch (n) {
                    case "CHG": { time = this.#chargeTime; break; }
                    case "DE": { time = this.#dryEndTime; break; }
                    case "FCS": { time = this.#firstCrackStartTime; break; }
                    case "FCE": { time = this.#firstCrackEndTime; break; }
                    case "SCS": { time = this.#secondCrackStartTime; break; }
                    case "SCE": { time = this.#secondCrackEndTime; break; }
                    case "COOL": { time = this.#coolTime; break; }
                }

                if (time == null || this.#startTime == null) return;

                var min = v * 60000;
                var sec = (time - this.#startTime) % 60000;
                time = min + sec + this.#startTime;
                this.#drawEvent(n, time);

                switch (n) {
                    case "CHG": { this.#chargeTime = time; break; }
                    case "DE": { this.#dryEndTime = time; break; }
                    case "FCS": { this.#firstCrackStartTime = time; break; }
                    case "FCE": { this.#firstCrackEndTime = time; break; }
                    case "SCS": { this.#secondCrackStartTime = time; break; }
                    case "SCE": { this.#secondCrackEndTime = time; break; }
                    case "COOL": { this.#coolTime = time; break; }
                }
            }

            setEventTimeSec(v, n)
            {
                if (v == "" || v == 0) return;

                var time = null;

                switch (n) {
                    case "CHG": { time = this.#chargeTime; break; }
                    case "DE": { time = this.#dryEndTime; break; }
                    case "FCS": { time = this.#firstCrackStartTime; break; }
                    case "FCE": { time = this.#firstCrackEndTime; break; }
                    case "SCS": { time = this.#secondCrackStartTime; break; }
                    case "SCE": { time = this.#secondCrackEndTime; break; }
                    case "COOL": { time = this.#coolTime; break; }
                }

                if (time == null || this.#startTime == null) return;

                var sec = (time - this.#startTime) % 60000;
                var min = time - this.#startTime - sec;

                sec = v * 1000;

                time = min + sec + this.#startTime;
                this.#drawEvent(n, time);

                switch (n) {
                    case "CHG": { this.#chargeTime = time; break; }
                    case "DE": { this.#dryEndTime = time; break; }
                    case "FCS": { this.#firstCrackStartTime = time; break; }
                    case "FCE": { this.#firstCrackEndTime = time; break; }
                    case "SCS": { this.#secondCrackStartTime = time; break; }
                    case "SCE": { this.#secondCrackEndTime = time; break; }
                    case "COOL": { this.#coolTime = time; break; }
                }
            }

            #drawEventTime(v, n)
            {
                if (this.#startTime == null) return;

                var min = (v - this.#startTime) / 60000;
                var sec = ((v - this.#startTime) % 60000) / 1000;
                document.getElementById(n+"Min").value = min.toFixed(0);
                document.getElementById(n+"Sec").value = sec.toFixed(0);
            }

            setDryEnd() {
                if (this.#dryEndTime == null && this.#chargeTime != null && this.#stopTime == null) {
                    this.#dryEndTime = performance.now();
                    this.#drawEvent("DE", this.#dryEndTime);
                    document.getElementById("dryEndButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#dryEndTime, "de");
                }
            }

            setFirstCrackStart() {
                if (this.#firstCrackStartTime == null && this.#dryEndTime != null && this.#stopTime == null) {
                    this.#firstCrackStartTime = performance.now();
                    this.#drawEvent("FCS", this.#firstCrackStartTime);
                    document.getElementById("fcStartButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#firstCrackStartTime, "fcs");
                }
            }

            setFirstCrackEnd() {
                if (this.#firstCrackEndTime == null && this.#firstCrackStartTime != null && this.#stopTime == null) {
                    this.#firstCrackEndTime = performance.now();
                    this.#drawEvent("FCE", this.#firstCrackEndTime);
                    document.getElementById("fcEndButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#firstCrackEndTime, "fce");
                }
            }

            setSecondCrackStart() {
                if (this.#secondCrackStartTime == null && this.#firstCrackEndTime != null && this.#stopTime == null) {
                    this.#secondCrackStartTime = performance.now();
                    this.#drawEvent("SCS", this.#secondCrackStartTime);
                    document.getElementById("scStartButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#secondCrackStartTime, "scs");
                }
            }

            setSecondCrackEnd() {
                if (this.#secondCrackEndTime == null && this.#secondCrackStartTime != null && this.#stopTime == null) {
                    this.#secondCrackEndTime = performance.now();
                    this.#drawEvent("SCE", this.#secondCrackEndTime);
                    document.getElementById("scEndButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#secondCrackEndTime, "sce");
                }
            }

            #endRoast() {
                document.getElementById("fanController").firstElementChild.style.height = "100%";
                document.getElementById("drumController").firstElementChild.style.height = "100%";
                document.getElementById("heaterController").firstElementChild.style.height = "0%"; 
                this.setFanSpeed(100);
                this.setDrumSpeed(100);
                this.setHeaterSpeed(0);
            }

            setCool() {
                if (this.#coolTime == null && this.#startTime != null && this.#stopTime == null) {
                    this.#coolTime = performance.now();
                    this.#drawEvent("COOL", this.#coolTime);
                    this.#endRoast();
                    document.getElementById("coolButton").classList.add('disabledElement');

                    this.#drawEventTime(this.#coolTime, "cool");
                }
            }

            setStop() {
                if (this.#stopTime == null && this.#startTime != null) {
                    this.#stopTime = performance.now();
                    this.#endRoast();
                    document.getElementById("stopButton").classList.add('disabledElement');
                }
            }

            setFanSpeed(percentage) {

                if (this.#startTime == null || this.#stopTime != null) return;
                var now = performance.now();
                this.#fanSettings.push([now, percentage]);

                this.#drawSetting(this.#fanSettings, this.#fanSettings.length - 1, now, this.#fanMotorLineColour);
            }

            setHeaterSpeed(percentage) {

                if (this.#startTime == null || this.#stopTime != null) return;
                var now = performance.now();
                this.#heaterSettings.push([now, percentage]);

                this.#drawSetting(this.#heaterSettings, this.#heaterSettings.length - 1, now, this.#heaterLineColour);
            }

            setDrumSpeed(percentage) {

                if (this.#startTime == null || this.#stopTime != null) return;
                var now = performance.now();
                this.#drumSettings.push([now, percentage]);

                this.#drawSetting(this.#drumSettings, this.#drumSettings.length - 1, now, this.#drumMotorLineColour);
            }

            #drawSetting(setting, index, now, colour) {
                var currTime = setting[index][0];
                var currSetting = setting[index][1];
                var prevTime = 0;
                var prevSetting = 0;

                if (index > 0) {
                    prevTime = setting[index - 1][0];
                    prevSetting = setting[index - 1][1];
                }
                else {
                    prevTime = currTime;
                    prevSetting = currSetting;
                }

                if (now > currTime) {
                    prevTime = currTime;
                    prevSetting = currSetting;
                    currTime = now;
                }

                prevTime -= this.#startTime;
                currTime -= this.#startTime;

                prevTime /= 60000;
                currTime /= 60000;

                if (prevSetting != currSetting)
                {
                    lineChart.drawCurveSegment(prevTime, prevSetting, currTime, prevSetting, false, colour);
                    lineChart.drawCurveSegment(currTime, prevSetting, currTime, currSetting, false, colour);
                }
                else
                {
                    lineChart.drawCurveSegment(prevTime, prevSetting, currTime, currSetting, false, colour);
                }
            }

            #rorProjection = 0; //c / min

            #drawBeanTemperatureProjection(temp, time) {
                var height = lineChart.getHeight() - 40*2;
                var width = lineChart.getWidth() - 38 - 20 - 40;
                var onemin = width / 25.0;
                var onec = height / 300.0;
                /*
                 *     /|
                 *   /  | ror * onec
                 * /    |
                 * ------
                 * 1min
                 * */
                var angle = 270.0 - Math.atan(this.#rorProjection * onec / onemin) * 180.0 / Math.PI;

                var currentTime = (time - this.#startTime) / 60000.0;

                var xoffset = lineChart.valToCanvasXoffset(currentTime) + (163.0-58.0);
                var yoffset = lineChart.valToCanvasYoffset(temp) - 220.0; //includes / affected by length

                //rotate 90deg, translatey -250px will put it horizontal
                //top 540px will put it right at zero degrees
                //left: 163 will put it right at zero seconds
                document.getElementById("beanTemperatureProjection").style.transform = "rotate(" + angle + "deg) translatey(250px)";
                document.getElementById("beanTemperatureProjection").style.left = xoffset + "px";
                document.getElementById("beanTemperatureProjection").style.top = yoffset + "px";
            }

            #dryingPhaseRORSum = 0;
            #dryingPhaseCount = 0;
            #maillardPhaseRORSum = 0;
            #maillardPhaseCount = 0;
            #developmentPhaseRORSum = 0;
            #developmentPhaseCount = 0;
            #coolingPhaseRORSum = 0;
            #coolingPhaseCount = 0;

            #dryingPhaseAUCSum = 0;
            #maillardPhaseAUCSum = 0;
            #developmentPhaseAUCSum = 0;
            #coolingPhaseAUCSum = 0;

            //4hz thermal cam update, so 30s smoothing
            #rorMA = new MovingAverage(4 * 30);
            #currTempMA = new MovingAverage(4 * 4);
            #prevTempMA = new MovingAverage(4 * 4);

            #prevROR = 0;

            #drawBeanTemperature(index, now) {
                var currTime = this.#beanTemperatures[index][0];
                var currTemp = this.#calcAvgBeanTemperature(index);// this.#beanTemperatures[index][1];
                var prevTime = 0;
                var prevTemp = 0;
                if (index > 0) {
                    prevTime = this.#beanTemperatures[index - 1][0];
                    prevTemp = this.#calcAvgBeanTemperature(index - 1);// this.#beanTemperatures[index - 1][1];
                }
                else {
                    prevTime = currTime;
                    prevTemp = currTemp;
                }

                prevTime -= this.#startTime;
                currTime -= this.#startTime;

                currTime /= 60000; //ms to min
                prevTime /= 60000; //ms to min

                var prevTempMovingAvg = this.#prevTempMA.ma(prevTemp);
                var currTempMovingAvg = this.#currTempMA.ma(currTemp);

                var ror = 0
                { //calculate ROR and draw ROR curve and text
                    // ror = this.#calcROR(prevTime, prevTemp, currTime, currTemp);
                    ror = this.#calcROR(prevTime, prevTempMovingAvg, currTime, currTempMovingAvg);
                    this.#rorProjection = this.#rorMA.ma(ror);

                    if (this.#prevROR == 0) {
                        this.#prevROR = this.#rorProjection;
                    }

                    lineChart.drawCurveSegment(prevTime, this.#prevROR, currTime, this.#rorProjection, true, '#ababab');
                    document.getElementById("ror").innerHTML = "ROR: " + this.#rorProjection.toFixed(2) + " °C/min";

                    this.#prevROR = this.#rorProjection;
                }

                var deltaAUC = this.#calcAUC(prevTime, prevTemp, currTime, currTemp);
                document.getElementById("auc").innerHTML = "AUC: " + this.#auc.toFixed(2) + " °C*min";

                //lineChart.drawCurveSegment(prevTime, prevTemp, currTime, currTemp);
                lineChart.drawCurveSegment(prevTime, prevTempMovingAvg, currTime, currTempMovingAvg);

                document.getElementById("bt").innerHTML = "BT: " + currTemp.toFixed(2) + " °C";

                var totalTime = now - this.#startTime;
                if (this.#coolTime != null)
                    totalTime = this.#coolTime - this.#startTime;

                if (this.#chargeTime != null) {
                    var dryingPhaseTime = now;
                    if (this.#dryEndTime != null) dryingPhaseTime = this.#dryEndTime;
                    dryingPhaseTime -= this.#chargeTime;
                    var dryingPhasePercentage = dryingPhaseTime / totalTime * 100.0;
                    dryingPhaseTime /= 1000.0;
                    var dryingPhaseTimeMin = dryingPhaseTime / 60;
                    document.getElementById("dryingPhaseTime").innerHTML = Math.floor(dryingPhaseTimeMin) + ":" + ((dryingPhaseTime) - Math.floor(dryingPhaseTimeMin) * 60).toFixed(1) + " " + dryingPhasePercentage.toFixed(1) + "%";

                    if (this.#dryEndTime == null || (now >= this.#chargeTime && now <= this.#dryEndTime)) {
                        this.#dryingPhaseCount++;
                        this.#dryingPhaseRORSum += ror;
                        this.#dryingPhaseAUCSum += deltaAUC;

                        document.getElementById("dryingPhaseStat").innerHTML = "ROR: " + (this.#dryingPhaseRORSum / this.#dryingPhaseCount).toFixed(1) + " AUC: " + (this.#dryingPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#dryEndTime != null) {
                    var maillardPhaseTime = now;
                    if (this.#firstCrackStartTime != null) maillardPhaseTime = this.#firstCrackStartTime;
                    maillardPhaseTime -= this.#dryEndTime;
                    var maillardPhasePercentage = maillardPhaseTime / totalTime * 100.0;
                    maillardPhaseTime /= 1000.0;
                    var maillardPhaseTimeMin = maillardPhaseTime / 60;
                    document.getElementById("maillardPhaseTime").innerHTML = Math.floor(maillardPhaseTimeMin) + ":" + ((maillardPhaseTime) - Math.floor(maillardPhaseTimeMin) * 60).toFixed(1) + " " + maillardPhasePercentage.toFixed(1) + "%";

                    if (this.#firstCrackStartTime == null || (now >= this.#dryEndTime && now <= this.#firstCrackStartTime)) {
                        this.#maillardPhaseCount++;
                        this.#maillardPhaseRORSum += ror;
                        this.#maillardPhaseAUCSum += deltaAUC;

                        document.getElementById("maillardPhaseStat").innerHTML = "ROR: " + (this.#maillardPhaseRORSum / this.#maillardPhaseCount).toFixed(1) + " AUC: " + (this.#maillardPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#firstCrackStartTime != null) {
                    var developmentPhaseTime = now;
                    if (this.#coolTime != null) developmentPhaseTime = this.#coolTime;
                    developmentPhaseTime -= this.#firstCrackStartTime;
                    var developmentPhasePercentage = developmentPhaseTime / totalTime * 100.0;
                    developmentPhaseTime /= 1000.0;
                    var developmentPhaseTimeMin = developmentPhaseTime / 60;
                    document.getElementById("developmentPhaseTime").innerHTML = Math.floor(developmentPhaseTimeMin) + ":" + ((developmentPhaseTime) - Math.floor(developmentPhaseTimeMin) * 60).toFixed(1) + " " + developmentPhasePercentage.toFixed(1) + "%";

                    if (this.#coolTime == null || (now >= this.#firstCrackStartTime && now <= this.#coolTime)) {
                        this.#developmentPhaseCount++;
                        this.#developmentPhaseRORSum += ror;
                        this.#developmentPhaseAUCSum += deltaAUC;

                        document.getElementById("developmentPhaseStat").innerHTML = "ROR: " + (this.#developmentPhaseRORSum / this.#developmentPhaseCount).toFixed(1) + " AUC: " + (this.#developmentPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#coolTime != null) {
                    var coolingPhaseTime = now;
                    coolingPhaseTime -= this.#coolTime;
                    //var coolingPhasePercentage = coolingPhaseTime / totalTime * 100.0;
                    coolingPhaseTime /= 1000.0;
                    var coolingPhaseTimeMin = coolingPhaseTime / 60;
                    document.getElementById("coolingPhaseTime").innerHTML = Math.floor(coolingPhaseTimeMin) + ":" + ((coolingPhaseTime) - Math.floor(coolingPhaseTimeMin) * 60).toFixed(1);// + " " + coolingPhasePercentage.toFixed(1) + "%";

                    if(now >= this.#coolTime)
                    {
                        this.#coolingPhaseCount++;
                        this.#coolingPhaseRORSum += ror;
                        this.#coolingPhaseAUCSum += deltaAUC;

                        document.getElementById("coolingPhaseStat").innerHTML = "ROR: " + (this.#coolingPhaseRORSum / this.#coolingPhaseCount).toFixed(1) + " AUC: " + (this.#coolingPhaseAUCSum).toFixed(1);
                    }
                }
            }

            //TODO
            //instead of calculating avg bean temps over and over again
            //create an array of averaged/filtered values
            //keep a window of moving average of 4 seconds
            //keep track of min/max values in that window
            //if min/max difference is >5 degrees then filter out the top outliers
            //then just need to sample the averaged filtered values when grabbing bean temps
            //same goes for rate of rise

            #calcAvgBeanTemperature(index)
            {
                if (this.#beanTemperatures.length < 1)
                {
                    return 0;
                }
                
                //calculate average bean temperature
                var avg = 0.0;
                var counter = 0;

                //x left 0, right 31
                //y top 0, bottom 23 

                for (var x = 0; x < 32; ++x)
                    for (var y = 0; y < 24; ++y) {
                        //average some pre-specified area of pixels
                        avg += this.#beanTemperatures[index][1][32 * (23 - y) + x] * beanFilterMask[32 * (23 - y) + x];
                        counter += beanFilterMask[32 * (23 - y) + x];
                    }
                avg /= counter;

                return avg;
            }

            setBeanTemperature(temperature) {
                if (this.#startTime == null || this.#stopTime != null) return;

                var now = performance.now();

                this.#beanTemperatures.push([now, temperature]);

                this.#drawBeanTemperature(this.#beanTemperatures.length - 1, now);

                this.#drawSetting(this.#fanSettings, this.#fanSettings.length - 1, now, this.#fanMotorLineColour);
                this.#drawSetting(this.#heaterSettings, this.#heaterSettings.length - 1, now, this.#heaterLineColour);
                this.#drawSetting(this.#drumSettings, this.#drumSettings.length - 1, now, this.#drumMotorLineColour);

                this.#drawBeanTemperatureProjection(this.#calcAvgBeanTemperature(this.#beanTemperatures.length - 1), now);
            }

            setAirTemperature(temperature) {
                if (this.#startTime == null || this.#stopTime != null) return;
                this.#airTemperatures.push([performance.now(), temperature]);
            }

            setExhaustTemperature(temperature) {
                if (this.#startTime == null || this.#stopTime != null) return;
                this.#exhaustTemperatures.push([performance.now(), temperature]);
            }

            setName(n) {
                this.#name = n;
            }

            setBeanType(type) {
                this.#beanType = type;
            }

            setMoistureContent(mc) {
                this.#moistureContent = mc;
            }

            setBeanScreenSize(ss) {
                this.#beanScreenSize = ss;
            }

            #calcWeightVolumeDensity() {
                if (this.#weight != null && this.#volume != null && this.#density != null) return;

                if (this.#density != null && this.#volume != null) {
                    this.#weight = this.#density * this.#volume;
                    document.getElementById("beanWeight").value = this.#weight.toFixed(1);
                    return;
                }

                if (this.#weight != null && this.#volume != null) {
                    this.#density = this.#weight / this.#volume;
                    document.getElementById("beanDensity").value = this.#density.toFixed(2);
                    return;
                }

                if (this.#density != null && this.#weight != null) {
                    this.#volume = this.#weight / this.#density;
                    document.getElementById("beanVolume").value = this.#volume.toFixed(1);
                    return;
                }
            }

            #calcEndWeightVolumeDensity() {
                if (this.#endWeight != null && this.#endVolume != null && this.#endDensity != null) return;

                if (this.#endDensity != null && this.#endVolume != null) {
                    this.#endWeight = this.#endDensity * this.#endVolume;
                    document.getElementById("endBeanWeight").value = this.#endWeight.toFixed(1);
                    return;
                }

                if (this.#endWeight != null && this.#endVolume != null) {
                    this.#endDensity = this.#endWeight / this.#endVolume;
                    document.getElementById("endBeanDensity").value = this.#endDensity.toFixed(2);
                    return;
                }

                if (this.#endDensity != null && this.#endWeight != null) {
                    this.#endVolume = this.#endWeight / this.#endDensity;
                    document.getElementById("endBeanVolume").value = this.#endVolume.toFixed(1);
                    return;
                }
            }

            setWeight(bw) {
                if (bw == "") this.#weight = null;
                else {
                    this.#weight = bw;
                    this.#calcWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            setVolume(bv) {
                if (bv == "" || bv == 0) this.#volume = null;
                else {
                    this.#volume = bv;
                    this.#calcWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            setDensity(bd) {
                if (bd == "" || bd == 0) this.#density = null;
                else {
                    this.#density = bd;
                    this.#calcWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            setEndWeight(ew) {
                if (ew == "") this.#endWeight = null;
                else {
                    this.#endWeight = ew;
                    this.#calcEndWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            setEndVolume(ev) {
                if (ev == "" || ev == 0) this.#endVolume = null;
                else {
                    this.#endVolume = ev;
                    this.#calcEndWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            setEndDensity(ed) {
                if (ed == "" || ed == 0) this.#endDensity = null;
                else {
                    this.#endDensity = ed;
                    this.#calcEndWeightVolumeDensity();
                    this.#updateWeightLoss();
                    this.#updateVolumeGain();
                }
            }

            getBeanTemperatures(t) {
                if (this.#beanTemperatures.length > 0) {
                    var i = 1;
                    for (; i < this.#beanTemperatures.length; ++i) {
                        if (this.#beanTemperatures[i][0] > (t + this.#startTime))
                            break;
                    }

                    //time beyond stored value range
                    if (i >= this.#beanTemperatures.length)
                    {
                        return null;
                    }

                    return this.#beanTemperatures[i][1];
                }

                return null;
            }

            getAvgBeanTemperature(t) {
                if (this.#beanTemperatures.length > 0) {
                    var i = 1;
                    for (; i < this.#beanTemperatures.length; ++i) {
                        if (this.#beanTemperatures[i][0] > (t + this.#startTime))
                            break;
                    }

                    //time beyond stored value range
                    if (i >= this.#beanTemperatures.length) {
                        return null;
                    }

                    return this.#calcAvgBeanTemperature(i - 1);// this.#beanTemperatures[i - 1][1];
                }

                return null;
            }

            getROR(t) {
                if (this.#beanTemperatures.length > 0) {
                    var i = 1;
                    for (; i < this.#beanTemperatures.length; ++i) {
                        if (this.#beanTemperatures[i][0] > (t + this.#startTime))
                            break;
                    }

                    var currTime = this.#beanTemperatures[i - 1][0];
                    var currTemp = this.#calcAvgBeanTemperature(i-1);// this.#beanTemperatures[i - 1][1];

                    var prevTime = 0;
                    var prevTemp = 0;

                    if (i < 2) {
                        prevTime = currTime;
                        prevTemp = currTemp;
                    } else {
                        prevTime = this.#beanTemperatures[i - 2][0];
                        prevTemp = this.#calcAvgBeanTemperature(i-2);// this.#beanTemperatures[i - 2][1];
                    }

                    prevTime -= this.#startTime;
                    currTime -= this.#startTime;

                    prevTime /= 60000;
                    currTime /= 60000;

                    var deltaTemp = Math.max(currTemp - prevTemp, 0.0);
                    var deltaTime = currTime - prevTime + 0.00001;

                    return deltaTemp / deltaTime;
                }

                return null;
            }

            getFanSpeed(t) {
                if (this.#fanSettings.length > 0) {
                    var i = 1;
                    for (; i < this.#fanSettings.length; ++i) {
                        if (this.#fanSettings[i][0] > (t + this.#startTime))
                            break;
                    }
                    return this.#fanSettings[i - 1][1];
                }

                return null;
            }

            getDrumSpeed(t) {
                if (this.#drumSettings.length > 0) {
                    var i = 1;
                    for (; i < this.#drumSettings.length; ++i) {
                        if (this.#drumSettings[i][0] > (t + this.#startTime))
                            break;
                    }
                    return this.#drumSettings[i - 1][1];
                }

                return null;
            }

            getHeaterSetting(t) {
                if (this.#heaterSettings.length > 0) {
                    var i = 1;
                    for (; i < this.#heaterSettings.length; ++i) {
                        if (this.#heaterSettings[i][0] > (t + this.#startTime))
                            break;
                    }
                    return this.#heaterSettings[i - 1][1];
                }

                return null;
            }
        }

        function scaleCanvas(canvas, ctx, w, h) {
            // Get the DPR and size of the canvas
            const dpr = window.devicePixelRatio;

            // Set the "actual" size of the canvas
            canvas.width = w * dpr;
            canvas.height = h * dpr;

            // Scale the context to ensure correct drawing operations
            ctx.scale(dpr, dpr);

            // Set the "drawn" size of the canvas
            canvas.style.width = `${w}px`;
            canvas.style.height = `${h}px`;

            return [w, h];
        }

        function lerp(v0, v1, t) {
            return (1 - t) * v0 + t * v1;
        }

        function saturate(x) {
            return Math.min(1.0, Math.max(x, 0.0));
        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function gammaCorrect(x)
        {
            return Math.pow(x, 1.0 / 2.2);
        }

        function colorRamp(v) {
            v = 2.0 * v;
            r = v - 0.0;
            g = v - 1.0;
            b = v - 2.0;

            r = 1.0 - r * r;
            g = 1.0 - g * g;
            b = 1.0 - b * b;

            r = Math.floor(saturate(r) * 255);
            g = Math.floor(saturate(g) * 255);
            b = Math.floor(saturate(b) * 255);

            return rgbToHex(r, g, b);
        }

        function pastelRamp(v)
        {
            //(.6 + .6 * cos(6.3 * (h) + vec4(0, 23, 21, 0)))

            r = 0.6 + 0.3 * Math.cos(6.3 * v + 0);
            g = 0.6 + 0.3 * Math.cos(6.3 * v + 23.0);
            b = 0.6 + 0.3 * Math.cos(6.3 * v + 21.0);

            r = gammaCorrect(r);
            g = gammaCorrect(g);
            b = gammaCorrect(b);

            r = Math.floor(saturate(r) * 255);
            g = Math.floor(saturate(g) * 255);
            b = Math.floor(saturate(b) * 255);

            return rgbToHex(r, g, b);
        }

        async function pickSaveFile() {
            fileToSave = await window.showSaveFilePicker({
                types: [{
                    description: "JSON file",
                    accept: { "text/plain": [".json"] }
                }]
            });
            var file = await fileToSave.getFile();
            document.getElementById('fileSavePath').value = file.name;
        }

        async function saveRoastProfile() {
            if (fileToSave != null)
            {
                //console.log(roastProfile.stringify());
                try {
                    const fileStream = await fileToSave.createWritable();
                    await fileStream.write(new Blob([roastProfile.stringify()], { type: "application/json" }));
                    await fileStream.close();
                }
                catch (e) {
                    document.getElementById("websocketMessages").innerHTML += e + "<br>";
                }
            }
        }

        function loadRoastProfile() {
            if (fileToLoad != null) { 
                try {
                    var reader = new FileReader();
                    reader.readAsText(fileToLoad);
                    reader.onload = function (evt) {
                        roastProfile = new RoastProfile();
                        roastProfile.parse(reader.result);
                    }
                }
                catch (e) {
                    document.getElementById("websocketMessages").innerHTML += e + "<br>";
                }
            }
        }

        function controlMove(initial, yPos, elem) {
            var curPercentage = elem.firstElementChild.clientHeight / elem.clientHeight;
            var delta = (initial - yPos);
            var percentage = (curPercentage + delta / elem.clientHeight) * 100;

            if (percentage > 100)
                percentage = 100;
            else if (percentage < 0)
                percentage = 0;
            elem.firstElementChild.style = "height: " + percentage + "%;";

            if (elem.getElementsByTagName("img")[0].id == "fanImage") {
                var animLen = 4 - 3.8 * percentage / 100;
                if (percentage == 0) {
                    elem.getElementsByTagName("img")[0].style = "animation: none;";
                }
                else {
                    elem.getElementsByTagName("img")[0].style = "animation: spin " + animLen + "s linear infinite;";
                }
            }

            if (elem.id == "fanController") {
                roastProfile.setFanSpeed(percentage);
            }
            else if (elem.id == "drumController") {
                roastProfile.setDrumSpeed(percentage);
            }
            else if (elem.id == "heaterController") {
                roastProfile.setHeaterSpeed(percentage);
            }

        }

        function controlFunc(e) {
            if (e.type == "mousedown") {
                controllerIsMouseDown = true;
                controllerInitialYPos = e.y;
                controllerClickedElem = this;
            }
            else if (e.type == "touchstart") {
                controllerIsMouseDown = true;
                controllerInitialYPos = e.targetTouches[0].clientY;
                controllerClickedElem = this;
            }
            else if (e.type == "mousemove") {
                if (controllerIsMouseDown) {
                    controlMove(controllerInitialYPos, e.y, controllerClickedElem);
                    controllerInitialYPos = e.y;
                }
            }
            else if (e.type == "touchmove") {
                if (controllerIsMouseDown) {
                    controlMove(controllerInitialYPos, e.targetTouches[0].clientY, controllerClickedElem);
                    controllerInitialYPos = e.targetTouches[0].clientY;
                }
            }
            else if (e.type == "mouseup" || e.type == "touchend") {
                controllerIsMouseDown = false;
            }

            if (controllerIsMouseDown) {
                e.preventDefault();
            }
        }

        function showRoastProperties() {
            document.getElementById('propertiesDialog').style.visibility = "visible";
            document.getElementById('backgroundBlur').style.visibility = "visible";
            document.getElementById('fanImage').style.animationPlayState = "paused";
            updateUI = false;
        }

        function hideRoastProperties() {
            document.getElementById('propertiesDialog').style.visibility = "hidden";
            document.getElementById('backgroundBlur').style.visibility = "hidden";
            document.getElementById('fanImage').style.animationPlayState = "running";
            updateUI = true;
        }

        var temperatureMA = new MovingAverage(100);
        function dummyData(t) {
            //test data for drawing a curve
            var dataSet = [
                22, //minute 0, eg starting
                43, 87, 120, //drying phase
                165, 177, 185, 192, 196, //yellowing, fc
                204, 213, 220, //development
                225, 226, 227, //second crack
                229, 232, 236, 239, 242, 245, //15-20mins
                199, 143, 93, 54, 25 //20-25mins
            ];

            var tMin = t / 60.0;
            var interp = tMin - Math.floor(tMin);
            var val = lerp(dataSet[Math.floor(tMin)], dataSet[Math.ceil(tMin)], interp);
            val = temperatureMA.ma(val);

            roastProfile.setBeanTemperature(val);

            setTimeout(dummyData.bind(null, t + 0.250), 250);
        }

        function drawBeanFilterMask(mask) {
                var canvas = document.getElementById("thermalCamera");
                canvas.style.visibility = "visible";
                canvas.width = 320;
                canvas.height = 240;
                var canvasCtx = canvas.getContext("2d");

                //x left 0, right 31
                //y top 0, bottom 23 
                for (x = 0; x < 32; ++x)
                    for (y = 0; y < 24; ++y) {
                        val = mask[32 * (23 - y) + x];

                        canvasCtx.fillStyle = val > 0 ? "#FFFFFF" : "#000000";
                        canvasCtx.fillRect(x * 10, y * 10, 10, 10);
                    }
        }
        
        function drawThermalCameraOutput(temperatures) {
            if (updateUI) {
                var canvas = document.getElementById("thermalCamera");
                canvas.style.visibility = "visible";
                canvas.width = 320;
                canvas.height = 240;
                var canvasCtx = canvas.getContext("2d");

                var min = 300.0;
                var max = -40.0;
                for (var x of temperatures) {
                    min = Math.min(x, min);
                    max = Math.max(x, max);
                }

                //x left 0, right 31
                //y top 0, bottom 23 
                for (x = 0; x < 32; ++x)
                    for (y = 0; y < 24; ++y) {
                        //const randomColor = Math.floor(Math.random() * 16777215).toString(16);
                        //randomTemp = Math.random(); //pretend that it's normalised to 0..1

                        temp = temperatures[32 * (23 - y) + x];

                        //if ((x == 11 || x == 13) && (y == 18 || y == 20)) { temp = 0; }

                        //map temperatures to 0..1
                        minTemp = min;//10.0; //-40c
                        maxTemp = max;//40.0; //+300c
                        temp = (temp - minTemp) / (maxTemp - minTemp);

                        canvasCtx.fillStyle = pastelRamp(1 - temp);
                        canvasCtx.fillRect(x * 10, y * 10, 10, 10);
                    }
            }
        }

        function analyseThermalCameraData(temperatures) {
            var temps = temperatures.slice().sort();
            var min = 300.0;
            var max = -40.0;
            var median = (temps[temps.length / 2] + temps[temps.length / 2 + 1]) / 2.0;
            for (var x of temps) {
                min = Math.min(x, min);
                max = Math.max(x, max);
            }
            document.getElementById("thermalCamMin").innerHTML = min.toFixed(1);
            document.getElementById("thermalCamMax").innerHTML = max.toFixed(1);
            document.getElementById("thermalCamMedian").innerHTML = median.toFixed(1);
        }

        function drawThermalCameraHistogram(temperatures) {
            var histoCanvas = document.getElementById("thermalCamHistogram");
            var histoCtx = histoCanvas.getContext("2d");

            var wh = scaleCanvas(histoCanvas, histoCtx, 300, 150);
            var canvasWidth = wh[0];
            var canvasHeight = wh[1];

            var min = 300.0;
            var max = -40.0;
            for (var x of temperatures) {
                min = Math.min(x, min);
                max = Math.max(x, max);
            }

            var histogram = new Map();
            for (var x = Math.floor(min); x <= Math.floor(max); ++x) {
                histogram.set(x, 0);
            }

            for (var x of temperatures) {
                histogram.set(Math.floor(x), histogram.get(Math.floor(x)) + 1);
            }

            var mostFrequentVal = 0;
            for (const [key, val] of histogram) {
                mostFrequentVal = Math.max(val, mostFrequentVal);
            }

            histoCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            histoCtx.fillStyle = "#555";
            var counter = 0;
            var barwidth = canvasWidth / histogram.size;
            for (const [key, val] of histogram) {
                histoCtx.fillRect(
                    (barwidth) * counter,
                    (1.0 - val / mostFrequentVal) * canvasHeight,
                    barwidth,
                    val / mostFrequentVal * canvasHeight);
                counter++;
            }
        }

        function toggleBeanFilterMask()
        {
            beanFilterMaskVisible = !beanFilterMaskVisible;

            if (beanFilterMaskVisible) {
                document.getElementById("beanFilterMaskCheckbox").firstElementChild.style.visibility = "visible";
                drawBeanFilterMask(beanFilterMask);
            } else
            {
                document.getElementById("beanFilterMaskCheckbox").firstElementChild.style.visibility = "hidden";
            }
        }

        function thermalCamClick(e) {
            if (beanFilterMaskVisible) {
                var x = Math.floor(e.offsetX / 10.0);
                var y = Math.floor(e.offsetY / 10.0);
                var samplePos = 32 * (23 - y) + x;

                if (e.type == "click") {
                    //left click, add to mask
                    beanFilterMask[samplePos] = 1.0;
                }
                else if (e.type == "contextmenu") {
                    //right click, remove from mask
                    beanFilterMask[samplePos] = 0.0;
                }

                drawBeanFilterMask(beanFilterMask);
            }
        }

        function thermalCamMove(e) {
            var x = Math.floor(e.offsetX / 10.0);
            var y = Math.floor(e.offsetY / 10.0);
            thermalCamSamplePos = 32 * (23 - y) + x;
            document.getElementById("thermalCamTooltip").style.left = e.pageX + 'px';
            document.getElementById("thermalCamTooltip").style.top = e.pageY + 'px';
        }

        function thermalCamTooltipUpdate() {
            if (thermalCamIsMouseIn && thermalCamTemperatures != null) {
                document.getElementById("thermalCamTooltip").innerHTML = thermalCamTemperatures[thermalCamSamplePos].toFixed(1) + " °C";

                setTimeout(thermalCamTooltipUpdate, 30);
            }
        }

        function thermalCamEnter(e) {
            thermalCamIsMouseIn = true;
            if (thermalCamTemperatures != null) {
                document.getElementById("thermalCamTooltip").style.visibility = "visible";
            }

            thermalCamTooltipUpdate();
        }

        function thermalCamLeave(e) {
            thermalCamIsMouseIn = false;
            document.getElementById("thermalCamTooltip").style.visibility = "hidden";
        }

        function lineChartMove(e) {
            var x = e.offsetX; 
            var y = e.offsetY;
            var leftBorder = 5 + 10 + 58;
            var rightBorder = e.target.clientWidth - 40 - 5;
            var topBorder = 5 + 10 + 40;
            var bottomBorder = e.target.clientHeight - 40 - 5;

            var xPos = e.pageX;
            var yPos = e.pageY;

            //compensate line being 5 off to left, 10 for padding
            if (x < leftBorder) {
                xPos -= (x - leftBorder);
                x = leftBorder;
            }

            if (x > rightBorder) {
                xPos -= x - rightBorder;
                x = rightBorder;
            }

            if (y < topBorder) {
                yPos -= (y - topBorder);
                y = topBorder;
            }

            if (y > bottomBorder) {
                yPos -= y - bottomBorder;
                y = bottomBorder;
            }

            var time = lineChart.canvasXoffsetToVal(x - 15);
            var temp = lineChart.canvasYoffsetToVal(y + 5);
            var ror = lineChart.canvasYoffsetToValSecondaryAxis(y + 5);

            document.getElementById("lineChartVerticalIndicator").style.left = xPos + 'px';
            document.getElementById("lineChartHorizontalIndicator").style.top = yPos + 'px';

            document.getElementById("lineChartTempHover").style.left = (leftBorder + 15) + 'px';
            document.getElementById("lineChartTempHover").style.top = (yPos - 18) + 'px';
            document.getElementById("lineChartTempHoverText").innerHTML =
                temp.toFixed(1);

            document.getElementById("lineChartTimeHover").style.top = (bottomBorder + 22) + 'px';
            document.getElementById("lineChartTimeHover").style.left = (xPos - 48) + 'px';
            document.getElementById("lineChartTimeHoverText").innerHTML =
                Math.floor(time) + ":" + ((time - Math.floor(time)) * 60).toFixed(0);

            document.getElementById("lineChartRorHover").style.left = (rightBorder + 84) + 'px';
            document.getElementById("lineChartRorHover").style.top = (yPos - 18) + 'px';
            document.getElementById("lineChartRorHoverText").innerHTML =
                ror.toFixed(1);

            var timems = time * 60000;
            var bt = roastProfile.getAvgBeanTemperature(timems);
            if (bt == null) return;
            var ror = roastProfile.getROR(timems);
            var fs = roastProfile.getFanSpeed(timems);
            var ds = roastProfile.getDrumSpeed(timems);
            var hs = roastProfile.getHeaterSetting(timems);

            var beanTemperatures = roastProfile.getBeanTemperatures(timems);
            if (beanTemperatures != null)
            {
                drawThermalCameraOutput(new Float32Array(beanTemperatures));
            }

            if (beanFilterMaskVisible) {
                drawBeanFilterMask(beanFilterMask);
            }
    
            document.getElementById("lineChartTooltip").style.left = xPos + 'px';
            document.getElementById("lineChartTooltip").style.top = e.pageY + 'px';

            document.getElementById("lineChartTooltipText").innerHTML = ""
                + bt.toFixed(1) + " °C" + "<br>"
                + ror.toFixed(1) + " °C/min" + "<br>"
                + "Fan: " + fs.toFixed(1) + "%<br>"
                + "Drum: " + ds.toFixed(1) + "%<br>"
                + "Heater: " + hs.toFixed(1) + "%";            
        }

        function lineChartEnter(e) {
            var bt = roastProfile.getAvgBeanTemperature(0);
            if (bt == null) return;
            document.getElementById("lineChartTooltip").style.visibility = "visible";
            document.getElementById("lineChartVerticalIndicator").style.visibility = "visible";
            document.getElementById("lineChartHorizontalIndicator").style.visibility = "visible";
            document.getElementById("lineChartTempHover").style.visibility = "visible";
            document.getElementById("lineChartTimeHover").style.visibility = "visible";
            document.getElementById("lineChartRorHover").style.visibility = "visible";
        }

        function lineChartLeave(e) {
            document.getElementById("lineChartTooltip").style.visibility = "hidden";
            document.getElementById("lineChartVerticalIndicator").style.visibility = "hidden";
            document.getElementById("lineChartVerticalIndicator").style.left = -999;
            document.getElementById("lineChartHorizontalIndicator").style.visibility = "hidden";
            document.getElementById("lineChartHorizontalIndicator").style.top = -999;
            document.getElementById("lineChartTempHover").style.visibility = "hidden";
            document.getElementById("lineChartTempHover").style.left = -999;
            document.getElementById("lineChartTimeHover").style.visibility = "hidden";
            document.getElementById("lineChartTimeHover").style.top = -999;
            document.getElementById("lineChartRorHover").style.visibility = "hidden";
            document.getElementById("lineChartRorHover").style.left = -999;
        }


        function connect() {
            try {
                serverURL = document.getElementById("wsAddress").value;
                webSocket = new WebSocket(serverURL);
                webSocket.binaryType = 'arraybuffer';

                webSocket.onerror = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Failed to connect to " + serverURL + "<br>";
                }

                webSocket.onclose = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Connection closed" + "<br>";

                    var tcc = document.getElementById("thermalCamera");
                    var tccCtx = tcc.getContext("2d");
                    tccCtx.clearRect(0, 0, 320, 240);
                    document.getElementById("offlineText").style.visibility = "visible";

                    document.getElementById("connectButton").classList.remove("disabledElement");
                    document.getElementById("disconnectButton").classList.add("disabledElement");
                    document.getElementById("heaterController").classList.add("disabledElement");
                    document.getElementById("fanController").classList.add("disabledElement");
                    document.getElementById("drumController").classList.add("disabledElement");
                }

                webSocket.onopen = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Connection opened successfully" + "<br>";
                    //webSocket.send(("a").repeat(65536*2));
                    webSocket.send("hello server!");

                    document.getElementById("offlineText").style.visibility = "hidden";

                    document.getElementById("connectButton").classList.add("disabledElement");
                    document.getElementById("disconnectButton").classList.remove("disabledElement");
                    document.getElementById("heaterController").classList.remove("disabledElement");
                    document.getElementById("fanController").classList.remove("disabledElement");
                    document.getElementById("drumController").classList.remove("disabledElement");
                }

                webSocket.onmessage = (event) => {
                    //document.getElementById("websocketMessages").innerHTML += "onmessage " + (typeof event.data) + "<br>";
                    if (typeof event.data == "string") {
                        document.getElementById("websocketMessages").innerHTML += event.data + "<br>";
                    }
                    else if (typeof event.data == "object") {
                        arrayBuf = event.data;
                        thermalCamTemperatures = new Float32Array(arrayBuf, 0, arrayBuf.byteLength / 4 - 1);

                        //correct for zinc sulphide window absorption of about 15%
                        const absorptionCoeff = 0.15; //default: 0.15
                        for (var x = 0; x < 768; ++x)
                        {
                            thermalCamTemperatures[x] = thermalCamTemperatures[x] / (1.0 - absorptionCoeff);
                        }

                        drawThermalCameraOutput(thermalCamTemperatures);
                        analyseThermalCameraData(thermalCamTemperatures);
                        drawThermalCameraHistogram(thermalCamTemperatures);
                        var Ta = (new Float32Array(arrayBuf))[768];
                        document.getElementById("airt").innerHTML = "AirT: " + Ta.toFixed(1) + " °C";

                        //warn user with red text if camera temp goes above threshold
                        //thermal camera is only rated to work up to 85c
                        const camTempThreshold = 70.0; //default: 70.0
                        if (Ta > camTempThreshold) {
                            document.getElementById("airt").style.color = "red";
                        }

                        if (roastProfile != null)
                        {
                            roastProfile.setBeanTemperature(thermalCamTemperatures);
                        }
                    }
                }
            }
            catch (error) {
                document.getElementById("websocketMessages").innerHTML += error.message + "<br>";
            }
        }

        function disconnect() {
            if (webSocket != undefined) {
                webSocket.close();
                webSocket = null;

                document.getElementById("connectButton").classList.remove("disabledElement");
                document.getElementById("disconnectButton").classList.add("disabledElement");
                document.getElementById("heaterController").classList.add("disabledElement");
                document.getElementById("fanController").classList.add("disabledElement");
                document.getElementById("drumController").classList.add("disabledElement");
            }
        }

        var fileToLoad = null;
        var fileToSave = null;
        var controllerIsMouseDown = false;
        var controllerInitialYPos = 0.0;
        var controllerClickedElem = undefined;
        var updateUI = true;
        var thermalCamTemperatures = null;
        var thermalCamSamplePos = 0;
        var thermalCamIsMouseIn = false;
        var roastProfile = null;
        var webSocket = null;
        var lineChart = null;
        var beanFilterMask = null;
        var beanFilterMaskVisible = false;

        (function () {
            //fill mask with values
            beanFilterMask = new Float32Array([
                0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1,
                1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0,
            ]);

            lineChart = new LineChart(document.getElementById("lineChart"),
                1400, //width           default: 1400
                800, //height           default: 800
                0, //min time (mins)    default: 0
                25, //max time (mins)   default: 25
                0, //min temp (c)       defaut: 0
                300, //max temp (c)     default: 300
                0, //min ror (c/min)    default: 0
                50 //max ror (c/min)    default: 50
            );
            lineChart.drawLineChartBackground(
                "Time (min)",    "Temp °C",                "ROR °C/min",
                [5, 10, 15, 20], [50, 100, 150, 200, 250], [10, 20, 30, 40]
            );

            document.addEventListener("mouseup", controlFunc);
            document.addEventListener("mousemove", controlFunc);

            for (c of document.getElementsByClassName("controller")) {
                c.addEventListener("mousedown", controlFunc);

                c.addEventListener("touchstart", controlFunc);
                c.addEventListener("touchend", controlFunc);
                c.addEventListener("touchmove", controlFunc);
            }

            document.getElementById("thermalCamera").addEventListener("mousemove", thermalCamMove);
            document.getElementById("thermalCamera").addEventListener("mouseenter", thermalCamEnter);
            document.getElementById("thermalCamera").addEventListener("mouseleave", thermalCamLeave);
            document.getElementById("thermalCamera").addEventListener("click", thermalCamClick);
            document.getElementById("thermalCamera").addEventListener("contextmenu", thermalCamClick);

            document.getElementById("lineChart").addEventListener("mousemove", lineChartMove);
            document.getElementById("lineChart").addEventListener("mouseenter", lineChartEnter);
            document.getElementById("lineChart").addEventListener("mouseleave", lineChartLeave);

            //input type number doesn't respect maxlength so we make it...
            var inputs = document.getElementsByTagName('input');
            for (var i of inputs) {
                i.addEventListener("input",
                    function ()
                    {
                        if (this.maxLength > 0 && this.value.length > this.maxLength)
                        {
                            this.value = this.value.slice(0, this.maxLength);
                        }
                    }
                );
            }

            window.onbeforeunload = function () { return "Are you sure you want to leave?"; };

            roastProfile = new RoastProfile();
        })();
    </script>
</body>
</html>

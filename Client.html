<html>
<style>
    body {
        background-color: #EBECF0;
        margin-top: 20px;
        margin-left: 10px;
        font-family: Verdana;
        -webkit-tap-highlight-color: transparent;
        text-shadow: 1px 1px white;
        color: #676767;
    }

    #phaseContainer {
        display: flex;
        flex-direction: row;
        width: 1430px;
        margin-left: 80px;
        margin-top: 20px;
        justify-content: space-evenly;
        font-size: 13px;
    }

    #phaseContainer > div{
        display: flex;
        flex-direction: column;
    }

    #offlineText {
        position: relative;
        top: -150px;
        height: 0;
        font-size: 20px;
        width: 100%;
        text-align: center;
    }

    #thermalCamTooltip{
        visibility: hidden;
        background: rgba(255 255 255 / 53%);
        margin-left: 15px;
        z-index: 999999;
        position:absolute;
        padding: 5px;
        border-radius: 10px;
    }

    .propertySectionTitle {
        width: 100%;
        display: block;
        margin-bottom: 10px;
        margin-top: 20px;
        text-align: center;
        color: #9397a4;
        font-weight: bold;
    }

    #propertiesInputForm{
        display: flex;
        flex-direction: column;
    }

    #propertiesInputForm > div{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    input {
        margin: 5px;
        width: 220px;
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #fff;
        border-radius: 30px;
        border: 0;
        height: 30px;
        padding: 16px;
        outline: 0;
        background-color: #EBECF0;
        transition: all 0.2s ease-in-out;
    }

    input:focus {
        box-shadow: inset 1px 1px 2px #babecc, inset -1px -1px 2px #fff
    }

    input:disabled {
        box-shadow: none;
        border: 1px solid #bebebe;
    }

    #actions{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        margin-right: 10px;
    }

    .actionButton{
        text-align: center;
        width: 50px;
        height: 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 13px;
    }

    #backgroundBlur {
        position: fixed;
        backdrop-filter: blur(5px);
        /*backdrop-filter: brightness(40%);*/
        z-index: 999;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }

    #websocketMessages {
        width: 97%;
        height: 100px;
        overflow-x: hidden;
        overflow-y: scroll;
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #fff;
        border-radius: 10px;
        border: 0;
        padding-left: 15px;
        outline: 0;
        background-color: #ececec;
        padding-top: 10px;
        font-size: 13px;
        margin-left: 5px;
    }

    #websocketMessages::-webkit-scrollbar {
        width: 20px;
    }

    #websocketMessages::-webkit-scrollbar-track {
    }

    #websocketMessages::-webkit-scrollbar-thumb {
        border-radius: 20px;
        background: #babecc;
        border: 1px solid #9b9b9b;
    }

    #websocketMessages::-webkit-scrollbar-thumb:hover {
        background: #a9adbb;
    }

    #websocketMessages::-webkit-scrollbar-thumb:active {
        background: #989caa;
    }

    #propertiesIcon {
        opacity: 0.5;
        cursor: pointer;
        transition: transform 0.5s;
        padding: 5px;
    }

    #propertiesIcon:hover {
        transform: rotate(90deg);
    }

    #propertiesIcon:active{
        opacity: 0.75;
    }

    #propertiesDialog {
        position: fixed;
        left: 0;
        right: 0;
        margin: 2% auto;
        width: 700px;
        padding: 20px;
        border-radius: 20px;
        box-shadow: -5px -5px 20px #b0b0b0, 5px 5px 20px black;
        background-color: #EBECF0;
        visibility: hidden;
        z-index: 99999;
    }

    #propertiesTitle {
        width: 100%;
        display: block;
        text-align: center;
        margin-bottom: 20px;
        color: #9397a4;
        font-weight: bold;
        font-size: 2em;
    }

    .button {
        border: 0;
        outline: 0;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        transition: all 0.2s ease-in-out;
        padding: 5px 8px 5px 8px;
        text-decoration: none;
        cursor: pointer;
        
        font-weight: bold;
        user-select: none;
    }

    .button:hover {
        box-shadow: -2px -2px 5px #fff, 2px 2px 5px #babecc;
    }

    .button:active {
        box-shadow: inset 1px 1px 2px #babecc, inset -1px -1px 2px #fff;
    }

    .closeButton {
        position: absolute;
        right: 15px;
        top: 12px;
    }

    .lineChart {
        margin: 0px 10px 0px 10px;
        padding: 10px;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
    }

    .thermalCam {
        width: 320px;
        height: 240px;
        background-color: grey;
        vertical-align: top;
        margin: 0px 10px 20px 10px;
        border-radius: 20px;
        background-color: #ebecf0;
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        background-image: url(img/noise.png);
    }

    .controller {
        box-shadow: -5px -5px 10px #fff, 5px 5px 10px #babecc;
        border-radius: 20px;
        background-color: #d1d4e0;
        width: 60px;
        height: 320px;
        display: flex;
        margin: 10px;
        user-select: none;
        transition: all 0.2s ease-in-out;
    }

    .controller:hover {
        box-shadow: -2px -2px 5px #fff, 2px 2px 5px #babecc;
    }

    .controller > span {
        width: inherit;
        background-color: #ebecf0;
        background-size: 100% 100%;
        display: block;
        border-radius: 20px;
        align-self: flex-end;
    }

    .controller > span > span {
        display: flex;
        height: 100%;
        color: #555;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        position: relative;
        bottom: 15px;
    }

    #fanImage {
        opacity: 0.75;
        animation: spin 1.35s linear infinite;
    }

    @keyframes spin 
    {
        100% 
        {
            transform: rotate(360deg);
        }
    }
</style>
<body>
    <!--
    Roast properties:
        date time, roast name, blend, individual bean types, batch, weights, volumes,
        density calculation, moisture, bean screen size, ambient temp/humidity/pressure,
        end weight, end volume, end density
    -->
    <div id="propertiesDialog">
        <span class="closeButton button" onclick="hideRoastProperties();">X</span>
        <span id="propertiesTitle">Roast Properties:</span>
        <div id="propertiesInputForm">
            <div>
                <input type="text" id="roastName" placeholder="Roast Name" title="Roast Name" oninput="roastProfile.setName(event.target.value)"/>
                <input type="date" readonly="readonly" disabled id="roastDate" title="Roast Date (auto filled)" />
                <input type="time" readonly="readonly" disabled id="roastTime" title="Roast Time (auto filled)" />
            </div>
            <span class="propertySectionTitle">Pre Roast Bean Data</span>
            <div>
                <input type="text" id="beanType" placeholder="Bean Type" title="Bean Type" oninput="roastProfile.setBeanType(event.target.value)" />
                <input type="number" id="moistureContent" placeholder="Moisture Content (%)" title="Moisture Content (%)" oninput="roastProfile.setMoistureContent(event.target.value)" />
                <input type="number" id="beanScreenSize" placeholder='Bean Screen Size (1/64")' title='Bean Screen Size (1/64")' oninput="roastProfile.setBeanScreenSize(event.target.value)" />
            </div>
            <div>
                <input type="number" id="beanWeight" placeholder="Bean Weight (g)" title="Bean Weight (g)" oninput="roastProfile.setWeight(event.target.value)" />
                <input type="number" id="beanVolume" placeholder="Bean Volume (mL)" title="Bean Volume (mL)" oninput="roastProfile.setVolume(event.target.value)"/>
                <input type="number" id="beanDensity" placeholder="Density (g/mL)" title="Density (g/mL)" oninput="roastProfile.setDensity(event.target.value)"/>
            </div>
            <span class="propertySectionTitle">Post Roast Bean Data</span>
            <div>
                <input type="number" id="endBeanWeight" placeholder="End Weight (g)" title="End Weight (g)" oninput="roastProfile.setEndWeight(event.target.value)" />
                <input type="number" id="endBeanVolume" placeholder="End Volume (mL)" title="End Volume (mL)" oninput="roastProfile.setEndVolume(event.target.value)" />
                <input type="number" id="endBeanDensity" placeholder="End Density (g/mL)" title="End Density (g/mL)" oninput="roastProfile.setEndDensity(event.target.value)" />
            </div>
            <span class="propertySectionTitle">Ambient Values</span>
            <div>
                <input type="number" readonly="readonly" disabled placeholder="Temperature (°C)" title="Temperature (°C)" id="ambientTemperature" />
                <input type="number" readonly="readonly" disabled placeholder="Humidity (%)" title="Humidity (%)" id="ambientHumidity"/>
                <input type="number" readonly="readonly" disabled placeholder="Pressure (atm)" title="Pressure (atm)" id="ambientPressure" />
            </div>
        </div>
        <span class="propertySectionTitle">Roast Profile Management</span>
        <div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center;">
            <input type="text" placeholder="Filename" readonly="readonly" disabled style="width:350px; margin-right:10px;" id="fileLoadPath" />
            <!--We'll be able to read/write a file using this.files[0] here-->
            <input type="file" id="filePicker" accept=".json" style="display:none;" onchange="document.getElementById('fileLoadPath').value = this.files[0].name; fileToLoad = this.files[0];" />
            <span class="button" onclick="document.getElementById('filePicker').click();" style="margin-right:10px;">
                <img src="img/file.png" width="20" />
                <!--Icons created by Kiranshastry - Flaticon-->
            </span>
            <span class="button" onclick="loadRoastProfile()">Load</span>
        </div>
        <div style="display: flex; flex-direction: row; justify-content: flex-start; align-items: center;">
            <input type="text" placeholder="Filename" readonly="readonly" disabled style="width:350px; margin-right:10px;" id="fileSavePath" />
            <span class="button" onclick="pickSaveFile()" style="margin-right:10px;">
                <img src="img/file.png" width="20" />
                <!--Icons created by Kiranshastry - Flaticon-->
            </span>
            <span class="button" onclick="saveRoastProfile()">Save</span>
        </div>
        <span class="propertySectionTitle">Connection settings</span>
        <div style="margin-top: 20px; margin-bottom: 10px; ">
            <input type="text" id="wsAddress" placeholder="Websocket address: ws://xxx.xxx.xxx.xxx:xxxxx" style=" width: 350px; margin-right: 10px; " />
            <span class="button" onclick="connect()" style="margin-right:10px;">Connect</span>
            <span class="button" onclick="disconnect()">Disconnect</span>
        </div>
        <div id="websocketMessages"></div>
    </div>

    <div id="backgroundBlur"></div>

    <div style="display: flex; flex-direction: row;">
        <div id="actions">
            <div class="button actionButton" onclick="showRoastProperties();" title="Start Roasting (Drying Phase Start)">
                <img src="img/properties.png" width="40" id="propertiesIcon" />
                <!--Icon created by Freepik - Flaticon-->
            </div>

            <div class="button actionButton" onclick="roastProfile.setStart()" title="Start Roasting">
                <span>START</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setCharge()" title="Charge beans (Drying Phase Start)">
                <span>CHG</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setDryEnd()" title="Insert Drying Phase End Event">
                <span>DRY<br />END</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setFirstCrackStart()" title="Insert First Crack Start Event">
                <span>FC<br />START</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setFirstCrackEnd()" title="Insert First Crack End Event">
                <span>FC<br />END</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setSecondCrackStart()" title="Insert Second Crack Start Event">
                <span>SC<br />START</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setSecondCrackEnd()" title="Insert Second Crack End Event">
                <span>SC<br />END</span>
            </div>

            <div class="button actionButton" onclick="roastProfile.setStop()" title="Stop Roasting and Start Cooldown">
                <span>STOP</span>
            </div>

            <div class="button actionButton" title="Replay Roast Profile">
                <img src="img/replay.png" width="40" style="opacity: 0.5; padding: 5px;" />
                <!--Icon created by Freepik - Flaticon-->
            </div>
        </div>

        <canvas id="lineChart" class="lineChart">
            Your browser does not support the canvas element.
        </canvas>

        <div style="display: flex; flex-direction: column;">
            <canvas id="thermalCamera" width="320" height="240" class="thermalCam">
                Your browser does not support the canvas element.
            </canvas>

            <span id="thermalCamTooltip"></span>

            <span id="offlineText">OFFLINE</span>

            <div style="display:flex; flex-direction:column; padding:10px;">
                <canvas id="thermalCamHistogram" width="300" height="150" style="border: 1px solid #bebebe; background-color: #d1d4e0"></canvas>
                <div style="display: flex; flex-direction: row; justify-content: space-around;">
                    <span id="thermalCamMin"></span>
                    <span id="thermalCamMedian"></span>
                    <span id="thermalCamMax"></span>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-around;">
                    <span>min</span>
                    <span>med</span>
                    <span>max</span>
                </div>
            </div>

            <div id="controllers" style="display: flex; flex-direction: row; justify-content: space-evenly;">
                <div id="fanController" class="controller" title="Cooling Fan Control">
                    <span style="height: 70%;">
                        <span><img src="img/fan.png" width="30" id="fanImage" /></span>
                        <!--Icon created by Dreamstale - Flaticon-->
                    </span>
                </div>

                <div id="drumController" class="controller" title="Drum Motor Control">
                    <span style="height: 70%;">
                        <span><img src="img/motor.png" width="50" style="opacity:0.75; rotate: 270deg;" /></span>
                        <!--Icon created by monkik - Flaticon-->
                    </span>
                </div>

                <div id="heaterController" class="controller" title="Heater Element Control">
                    <span style="height: 70%;">
                        <span><img src="img/fire.png" width="40" style="opacity:0.75;" /></span>
                        <!--Icon created by Those Icons - Flaticon-->
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div id="phaseContainer">
        <div>
            <span>Drying Phase</span>
            <span id="dryingPhaseTime"></span>
            <span id="dryingPhaseStat"></span>
        </div>
        <div>
            <span>Maillard Phase</span>
            <span id="maillardPhaseTime"></span>
            <span id="maillardPhaseStat"></span>
        </div>
        <div>
            <span>Development Phase</span>
            <span id="developmentPhaseTime"></span>
            <span id="developmentPhaseStat"></span>
        </div>
        <div>
            <span>Cooling Phase</span>
            <span id="coolingPhaseTime"></span>
            <span id="coolingPhaseStat"></span>
        </div>
    </div>

    <div style="display: flex; flex-direction: row; justify-content: space-evenly; width: 1160px; left: 205px; top: 30px; position: absolute;">
        <span id="auc"></span>
        <span id="ror"></span>
        <span id="bt"></span>
        <span id="airt">AirT: xx*C</span>
        <span id="ext">ExT: xx*C</span>
    </div>


    <script>
        // Heating elements:
        // afterburner 230v (2 wire)
        // quartz heater 115v each
        //
        // Motors to be controlled:
        // dc exhaust fan 12v 0.2a (2 wire)
        // dc logic board cooling fan 12v 0.2a (2 wire)
        // drum motor 16v (2 wire)
        // afterburner draw fan 230v
        // scroll / cooling fan 230v
        //
        // On/off switch:
        // light bulb 230v
        //
        // Sensors:
        // draw fan thermocouple
        // exhaust fan thermocouple
        // main chamber thermocouple
        // thermal camera 3.3v

        //https://www.wikiwand.com/en/Coffee_roasting
        //22c  unroasted
        //165c drying phase
        //196c cinnamon roast (right after first crack)
        //205c new england roast
        //210c american roast
        //219c city roast (common for speciality coffee)
        //225c full city roast (beginning of second crack)
        //230c vienna roast
        //240c french roast
        //245c italian roast

        class MovingAverage {
            #containerMA = [];
            #maxSize = 1000;
            constructor(ms) {
                this.#maxSize = ms;
            }

            ma(x) {
                this.#containerMA.push(x);

                var avg = 0;
                for (var v of this.#containerMA) {
                    avg += v;
                }
                avg /= this.#containerMA.length;

                if (this.#containerMA.length >= this.#maxSize) {
                    this.#containerMA.shift();
                }

                return avg;
            }
        } 

        class LineChart {
            #horizontalMinVal;
            #horizontalMaxVal;
            #verticalMinVal;
            #verticalMaxVal;
            #secondaryVerticalMinVal;
            #secondaryVerticalMaxVal;
            #canvasWidth;
            #canvasHeight;
            #ctx;
            #vertAxisOffsetX;

            constructor(canvas, cWidth, cHeight, hMinVal, hMaxVal, vMinVal, vMaxVal, vsMinVal, vsMaxVal) {
                var c = canvas.getContext("2d");
                var wh = scaleCanvas(canvas, c, cWidth, cHeight);
                cWidth = wh[0];
                cHeight = wh[1];
                this.#ctx = c;
                this.#canvasWidth = cWidth;
                this.#canvasHeight = cHeight;
                this.#horizontalMinVal = hMinVal;
                this.#horizontalMaxVal = hMaxVal;
                this.#verticalMinVal = vMinVal;
                this.#verticalMaxVal = vMaxVal;
                this.#vertAxisOffsetX = 0;
                this.#secondaryVerticalMinVal = vsMinVal;
                this.#secondaryVerticalMaxVal = vsMaxVal;
            }

            #valToCanvasYoffset(v) {
                var spaceAvailable = this.#canvasHeight - 40 * 2;
                return this.#canvasHeight - 40 - (v - this.#verticalMinVal) / (this.#verticalMaxVal - this.#verticalMinVal) * spaceAvailable;
            }

            #valToCanvasYoffsetSecondaryAxis(v) {
                var spaceAvailable = this.#canvasHeight - 40 * 2;
                return this.#canvasHeight - 40 - (v - this.#secondaryVerticalMinVal) / (this.#secondaryVerticalMaxVal - this.#secondaryVerticalMinVal) * spaceAvailable;
            }

            #drawHorizontalLines(v, xOffset) {
                var line = new Path2D();
                var yOffset = this.#valToCanvasYoffset(v);
                line.moveTo(xOffset + 15, yOffset);
                line.lineTo(this.#canvasWidth - 40, yOffset);
                this.#ctx.stroke(line);
            }

            #drawHorizontalSecondaryLines(xOffset, v) {
                var line = new Path2D();
                var yOffset = this.#valToCanvasYoffsetSecondaryAxis(v);
                var chartWidth = (this.#canvasWidth - 40) - (xOffset + 15);
                line.moveTo(xOffset + 15 + chartWidth - 5, yOffset);
                line.lineTo(xOffset + 15 + chartWidth + 5, yOffset);
                this.#ctx.stroke(line);
            }

            #drawVerticalAxisText(v) {
                var lineOffsetY = this.#valToCanvasYoffset(v);
                this.#ctx.fillText(v, 5, lineOffsetY + 7);
                return this.#ctx.measureText(v).width;
            }

            #drawSecondaryVerticalAxisText(xOffset, v) {
                var lineOffsetY = this.#valToCanvasYoffsetSecondaryAxis(v);
                var chartWidth = (this.#canvasWidth - 40) - (xOffset + 15);
                this.#ctx.fillText(v, xOffset + 15 + chartWidth + 15, lineOffsetY + 7);
            }

            #valToCanvasXoffset(v, offsetX) {
                var spaceAvailable = this.#canvasWidth - 40 - (offsetX + 20);
                return offsetX + 20 + (v - this.#horizontalMinVal) / (this.#horizontalMaxVal - this.#horizontalMinVal) * spaceAvailable;
            }

            #drawHorizontalAxisText(v, vertAxisOffsetX) {
                var offsetX = this.#valToCanvasXoffset(v, vertAxisOffsetX);

                var textWidth = this.#ctx.measureText(v).width;

                this.#ctx.fillText(v, offsetX - textWidth / 2, this.#canvasHeight - 10);
            }

            #drawVertixalLines(v, vertAxisOffsetX, offsetY) {
                var offsetX = this.#valToCanvasXoffset(v, vertAxisOffsetX);

                var line = new Path2D();
                line.moveTo(offsetX, this.#canvasHeight - 40 + offsetY);
                line.lineTo(offsetX, 40);
                this.#ctx.stroke(line);
            }

            drawEventLine(x, title, subtitle, subsubtitle) {
                var xPos = this.#valToCanvasXoffset(x, this.#vertAxisOffsetX);
                this.#ctx.font = "13px Verdana";
                this.#ctx.fillText(title, xPos - this.#ctx.measureText(title).width / 2, 55);
                this.#ctx.fillText(subtitle, xPos - this.#ctx.measureText(subtitle).width / 2, 55 + 13);
                this.#ctx.fillText(subsubtitle, xPos - this.#ctx.measureText(subsubtitle).width / 2, 55 + 13 * 2);

                var line = new Path2D();
                line.moveTo(xPos, this.#canvasHeight - 40);
                line.lineTo(xPos, 50 + 3 * 13);
                this.#ctx.lineWidth = 2.0;
                this.#ctx.stroke(line);
            }

            drawLineChartBackground(
                horizontalAxisTitleStr, verticalAxisTitleStr,
                secondaryVerticalAxisTitleStr,
                horizontalLabelArray, verticalLabelArray,
                secondaryVerticalLabelArray
            ) {
                //vertical axis title
                this.#ctx.font = "20px Verdana";
                this.#ctx.fillStyle = "#676767";
                this.#ctx.fillText(verticalAxisTitleStr, 10, 20);

                //horizontal axis title
                var horizontalAxisTextSize = this.#ctx.measureText(horizontalAxisTitleStr).width;
                this.#ctx.fillText(horizontalAxisTitleStr, this.#canvasWidth - horizontalAxisTextSize - 20, this.#canvasHeight - 10);

                this.#ctx.fillText(secondaryVerticalAxisTitleStr, this.#canvasWidth - this.#ctx.measureText(secondaryVerticalAxisTitleStr).width - 20, 20);

                //draw vertical axis texts
                for (var i of verticalLabelArray) {
                    this.#vertAxisOffsetX = Math.max(this.#vertAxisOffsetX, this.#drawVerticalAxisText(i));
                }

                //draw secondary vertical axis texts
                for (var i of secondaryVerticalLabelArray) {
                    this.#drawSecondaryVerticalAxisText(this.#vertAxisOffsetX, i);
                    this.#drawHorizontalSecondaryLines(this.#vertAxisOffsetX, i);
                }

                //draw horizontal axis texts
                for (var i of horizontalLabelArray) {
                    this.#drawHorizontalAxisText(i, this.#vertAxisOffsetX);
                }

                //draw horizontal lines
                this.#ctx.strokeStyle = 'rgba(0, 0, 0, 0.25)';
                this.#drawHorizontalLines(this.#verticalMinVal, this.#vertAxisOffsetX + 5);
                this.#drawHorizontalLines(this.#verticalMaxVal, this.#vertAxisOffsetX + 5);
                for (var i of verticalLabelArray) {
                    this.#drawHorizontalLines(i, this.#vertAxisOffsetX);
                }


                //draw vertical lines
                this.#drawVertixalLines(this.#horizontalMinVal, this.#vertAxisOffsetX, 0);
                this.#drawVertixalLines(this.#horizontalMaxVal, this.#vertAxisOffsetX, 0)
                for (var i of horizontalLabelArray) {
                    this.#drawVertixalLines(i, this.#vertAxisOffsetX, 5);
                }
            }

            drawCurveSegment(prevH, prevV, h, v, secondary = false, colour = '#676767') {
                this.#ctx.strokeStyle = colour;
                this.#ctx.lineCap = "round";
                this.#ctx.lineJoin = "round";
                this.#ctx.lineWidth = 4.0;
                var line = new Path2D();
                var xfrom = this.#valToCanvasXoffset(prevH, this.#vertAxisOffsetX);
                var xto = this.#valToCanvasXoffset(h, this.#vertAxisOffsetX);
                var yfrom = 0;
                var yto = 0;
                if (!secondary) {
                    yfrom = this.#valToCanvasYoffset(prevV);
                    yto = this.#valToCanvasYoffset(v);
                }
                else {
                    yfrom = this.#valToCanvasYoffsetSecondaryAxis(prevV);
                    yto = this.#valToCanvasYoffsetSecondaryAxis(v);
                }
                line.moveTo(xfrom, yfrom);
                line.lineTo(xto, yto);
                this.#ctx.stroke(line);
            }
        }

        class RoastProfile {
            #startTime = null; //in milliseconds using performance.now()
            #chargeTime = null;
            #dryEndTime = null;
            #firstCrackStartTime = null;
            #firstCrackEndTime = null;
            #secondCrackStartTime = null;
            #secondCrackEndTime = null;
            #stopTime = null;

            #fanSettings = []; //stores pairs of (performance.now(), percentage%)
            #heaterSettings = [];
            #drumSettings = [];

            #beanTemperatures = []; //stores pairs of (performance.now(), temperature in C)
            #airTemperatures = [];
            #exhaustTemperatures = [];

            #name = null;
            #date = null; //JS Date()
            #beanType = null;
            #moistureContent = null; //%
            #beanScreenSize = null; //1/64"
            #weight = null; //g
            #volume = null; //mL
            #density = null; //g/mL
            #endWeight = null;
            #endVolume = null;
            #endDensity = null;
            #ambientTemperature = null;
            #ambientHumidity = null; //%
            #ambientPressure = null; //atm

            stringify() {
                return JSON.stringify(
                    {
                        '#startTime': this.#startTime,
                        '#chargeTime': this.#chargeTime,
                        '#dryEndTime': this.#dryEndTime,
                        '#firstCrackStartTime': this.#firstCrackStartTime,
                        '#firstCrackEndTime': this.#firstCrackEndTime,
                        '#secondCrackStartTime': this.#secondCrackStartTime,
                        '#secondCrackEndTime': this.#secondCrackEndTime,
                        '#stopTime': this.#stopTime,
                        '#fanSettings': this.#fanSettings,
                        '#heaterSettings': this.#heaterSettings,
                        '#drumSettings': this.#drumSettings,
                        '#beanTemperatures': this.#beanTemperatures,
                        '#airTemperatures': this.#airTemperatures,
                        '#exhaustTemperatures': this.#exhaustTemperatures,
                        '#name': this.#name,
                        '#date': this.#date,
                        '#beanType': this.#beanType,
                        '#moistureContent': this.#moistureContent,
                        '#beanScreenSize': this.#beanScreenSize,
                        '#weight': this.#weight,
                        '#volume': this.#volume,
                        '#density': this.#density,
                        '#endWeight': this.#endWeight,
                        '#endVolume': this.#endVolume,
                        '#endDensity': this.#endDensity,
                        '#ambientTemperature': this.#ambientTemperature,
                        '#ambientHumidity': this.#ambientHumidity,
                        '#ambientPressure': this.#ambientPressure,
                    }
                );
            }

            parse(s) {
                var j = JSON.parse(s);

                this.#startTime = j['#startTime'];
                this.#chargeTime = j['#chargeTime'];
                this.#dryEndTime = j['#dryEndTime'];
                this.#firstCrackStartTime = j['#firstCrackStartTime'];
                this.#firstCrackEndTime = j['#firstCrackEndTime'];
                this.#secondCrackStartTime = j['#secondCrackStartTime'];
                this.#secondCrackEndTime = j['#secondCrackEndTime'];
                this.#stopTime = j['#stopTime'];
                this.#fanSettings = j['#fanSettings'];
                this.#heaterSettings = j['#heaterSettings'];
                this.#drumSettings = j['#drumSettings'];
                this.#beanTemperatures = j['#beanTemperatures'];
                this.#airTemperatures = j['#airTemperatures'];
                this.#exhaustTemperatures = j['#exhaustTemperatures'];
                this.#name = j['#name'];
                this.#date = new Date(j['#date']);
                this.#beanType = j['#beanType'];
                this.#moistureContent = j['#moistureContent'];
                this.#beanScreenSize = j['#beanScreenSize'];
                this.#weight = j['#weight'];
                this.#volume = j['#volume'];
                this.#density = j['#density'];
                this.#endWeight = j['#endWeight'];
                this.#endVolume = j['#endVolume'];
                this.#endDensity = j['#endDensity'];
                this.#ambientTemperature = j['#ambientTemperature'];
                this.#ambientHumidity = j['#ambientHumidity'];
                this.#ambientPressure = j['#ambientPressure'];

                this.#updateDialog();

                for (var i = 0; i < this.#beanTemperatures.length; ++i)
                    this.#drawBeanTemperature(i, this.#beanTemperatures[i][0]);

                if (this.#chargeTime != null && this.#startTime != null)
                    this.#drawEvent("CHG", this.#chargeTime);

                if (this.#dryEndTime != null && this.#startTime != null)
                    this.#drawEvent("DE", this.#dryEndTime);

                if (this.#firstCrackStartTime != null && this.#startTime != null)
                    this.#drawEvent("FCS", this.#firstCrackStartTime);

                if (this.#firstCrackEndTime != null && this.#startTime != null)
                    this.#drawEvent("FCE", this.#firstCrackEndTime);

                if (this.#secondCrackStartTime != null && this.#startTime != null)
                    this.#drawEvent("SCS", this.#secondCrackStartTime);

                if (this.#secondCrackEndTime != null && this.#startTime != null)
                    this.#drawEvent("SCE", this.#secondCrackEndTime);

                if (this.#stopTime != null && this.#startTime != null)
                    this.#drawEvent("STOP", this.#stopTime);
            }

            #prevROR = 0;
            #calcROR(prevTime, prevTemp, currTime, currTemp) {
                var deltaTemp = Math.max(currTemp - prevTemp, 0.0);
                var deltaTime = currTime - prevTime + 0.00001;
                var ror = deltaTemp / deltaTime;

                if (this.#beanTemperatures.length == 1) {
                    this.#prevROR = ror;
                }

                lineChart.drawCurveSegment(prevTime, this.#prevROR, currTime, ror, true, '#ababab');
                document.getElementById("ror").innerHTML = "ROR: " + ror.toFixed(2) + " °C/min";

                this.#prevROR = ror;

                return ror;
            }

            #auc = 0;
            #calcAUC(prevTime, prevTemp, currTime, currTemp) {
                var threshold = 110;

                var deltaTime = currTime - prevTime + 0.00001;

                var deltaAUC = 0;

                if (currTemp > prevTemp) {
                    /*
                     *   /|  current temp
                     *  / |
                     * /--|  prev temp
                     * |  |
                     * |--|  ambient temp
                     * |  |
                     * ----  time elapsed
                     *
                     * */
                    if (currTemp > threshold) {
                        var deltaRect = Math.max(prevTemp - threshold, 0) * deltaTime;
                        var deltaTri = Math.abs(currTemp - prevTemp) * deltaTime / 2.0;
                        deltaAUC = deltaRect + deltaTri;
                        this.#auc += deltaAUC;
                    }
                }
                else {
                    /*
                     * |\    current temp
                     * | \
                     * |--\  prev temp
                     * |  |
                     * |--|  ambient temp
                     * |  |
                     * ----  time elapsed
                     *
                     * */
                    if (prevTemp > threshold) {
                        var deltaRect = Math.max(currTemp - threshold, 0) * deltaTime;
                        var deltaTri = Math.abs(currTemp - prevTemp) * deltaTime / 2.0;
                        deltaAUC = deltaRect + deltaTri;
                        this.#auc += deltaAUC;
                    }
                }

                document.getElementById("auc").innerHTML = "AUC: " + this.#auc.toFixed(2) + " °C*min";

                lineChart.drawCurveSegment(prevTime, prevTemp, currTime, currTemp);

                return deltaAUC;
            }

            #updateDialog() {
                if(this.#ambientTemperature != null)
                    document.getElementById("ambientTemperature").value = this.#ambientTemperature;

                if(this.#ambientHumidity != null)
                    document.getElementById("ambientHumidity").value = this.#ambientHumidity;

                if(this.#ambientPressure != null)
                    document.getElementById("ambientPressure").value = this.#ambientPressure;

                if (this.#date != null) {
                    document.getElementById("roastDate").valueAsDate = this.#date;
                    document.getElementById("roastTime").valueAsDate = this.#date;
                }

                if (this.#name != null) 
                    document.getElementById("roastName").value = this.#name;

                if (this.#beanType != null)
                    document.getElementById("beanType").value = this.#beanType;

                if (this.#moistureContent != null)
                    document.getElementById("moistureContent").value = this.#moistureContent;

                if (this.#beanScreenSize != null)
                    document.getElementById("beanScreenSize").value = this.#beanScreenSize;

                if (this.#weight != null)
                    document.getElementById("beanWeight").value = this.#weight;

                if (this.#volume != null)
                    document.getElementById("beanVolume").value = this.#volume;

                if (this.#density != null)
                    document.getElementById("beanDensity").value = this.#density;

                if (this.#endWeight != null)
                    document.getElementById("endBeanWeight").value = this.#endWeight;

                if (this.#endVolume != null)
                    document.getElementById("endBeanVolume").value = this.#endVolume;

                if (this.#endDensity != null)
                    document.getElementById("endBeanDensity").value = this.#endDensity;
            }

            setStart() {
                if (this.#startTime == null) {
                    this.#startTime = performance.now();
                    this.#date = new Date();

                    this.#ambientTemperature = 24.0; //TODO read from sensor
                    this.#ambientHumidity = 50.0;
                    this.#ambientPressure = 1.0;

                    this.#updateDialog();

                    //for dev purposes
                    dummyData(0);
                }
            }

            #drawEvent(str, inputTime) {
                var i = 1;
                for (; i < this.#beanTemperatures.length; ++i) {
                    if (this.#beanTemperatures[i][0] > inputTime) break;
                }
                var time = (inputTime - this.#startTime) / 60000;
                lineChart.drawEventLine(time, str, Math.floor(time) + ":" + (time * 60 - Math.floor(time) * 60).toFixed(0), this.#beanTemperatures[i - 1][1].toFixed(1) + "°C");
            }

            setCharge() {
                if (this.#chargeTime == null && this.#startTime != null) {
                    this.#chargeTime = performance.now();
                    this.#drawEvent("CHG", this.#chargeTime);
                }
            }

            setDryEnd() {
                if (this.#dryEndTime == null && this.#chargeTime != null) {
                    this.#dryEndTime = performance.now();
                    this.#drawEvent("DE", this.#dryEndTime);
                }
            }

            setFirstCrackStart() {
                if (this.#firstCrackStartTime == null && this.#dryEndTime != null) {
                    this.#firstCrackStartTime = performance.now();
                    this.#drawEvent("FCS", this.#firstCrackStartTime);
                }
            }

            setFirstCrackEnd() {
                if (this.#firstCrackEndTime == null && this.#firstCrackStartTime != null) {
                    this.#firstCrackEndTime = performance.now();
                    this.#drawEvent("FCE", this.#firstCrackEndTime);
                }
            }

            setSecondCrackStart() {
                if (this.#secondCrackStartTime == null && this.#firstCrackEndTime != null) {
                    this.#secondCrackStartTime = performance.now();
                    this.#drawEvent("SCS", this.#secondCrackStartTime);
                }
            }

            setSecondCrackEnd() {
                if (this.#secondCrackEndTime == null && this.#secondCrackStartTime != null) {
                    this.#secondCrackEndTime = performance.now();
                    this.#drawEvent("SCE", this.#secondCrackEndTime);
                }
            }

            setStop() {
                if (this.#stopTime == null && this.#startTime != null) {
                    this.#stopTime = performance.now();
                    this.#drawEvent("STOP", this.#stopTime);
                }
            }

            setFanSpeed(percentage) {

                if (this.#startTime == null) return;
                this.#fanSettings.push([performance.now(), percentage]);
            }

            setHeaterSpeed(percentage) {

                if (this.#startTime == null) return;
                this.#heaterSettings.push([performance.now(), percentage]);
            }

            setDrumSpeed(percentage) {

                if (this.#startTime == null) return;
                this.#drumSettings.push([performance.now(), percentage]);
            }

            #dryingPhaseRORSum = 0;
            #dryingPhaseCount = 0;
            #maillardPhaseRORSum = 0;
            #maillardPhaseCount = 0;
            #developmentPhaseRORSum = 0;
            #developmentPhaseCount = 0;
            #coolingPhaseRORSum = 0;
            #coolingPhaseCount = 0;

            #dryingPhaseAUCSum = 0;
            #maillardPhaseAUCSum = 0;
            #developmentPhaseAUCSum = 0;
            #coolingPhaseAUCSum = 0;

            #drawBeanTemperature(index, now) {
                var currTime = this.#beanTemperatures[index][0];
                var currTemp = this.#beanTemperatures[index][1]
                var prevTime = 0;
                var prevTemp = 0;
                if (index > 1) {
                    prevTime = this.#beanTemperatures[index - 1][0];
                    prevTemp = this.#beanTemperatures[index - 1][1];
                    prevTime -= this.#startTime;
                }
                else {
                    prevTime = 0;
                    prevTemp = currTemp;
                }

                currTime -= this.#startTime;

                currTime /= 60000; //ms to min
                prevTime /= 60000; //ms to min

                var ror = this.#calcROR(prevTime, prevTemp, currTime, currTemp);
                var deltaAUC = this.#calcAUC(prevTime, prevTemp, currTime, currTemp);

                lineChart.drawCurveSegment(prevTime, prevTemp, currTime, currTemp);

                document.getElementById("bt").innerHTML = "BT: " + currTemp.toFixed(2) + " °C";

                var totalTime = now - this.#startTime;

                if (this.#chargeTime != null) {
                    var dryingPhaseTime = now;
                    if (this.#dryEndTime != null) dryingPhaseTime = this.#dryEndTime;
                    dryingPhaseTime -= this.#chargeTime;
                    var dryingPhasePercentage = dryingPhaseTime / totalTime * 100.0;
                    dryingPhaseTime /= 1000.0;
                    var dryingPhaseTimeMin = dryingPhaseTime / 60;
                    document.getElementById("dryingPhaseTime").innerHTML = Math.floor(dryingPhaseTimeMin) + ":" + ((dryingPhaseTime) - Math.floor(dryingPhaseTimeMin) * 60).toFixed(1) + " " + dryingPhasePercentage.toFixed(1) + "%";

                    if (this.#dryEndTime == null || (now >= this.#chargeTime && now <= this.#dryEndTime)) {
                        this.#dryingPhaseCount++;
                        this.#dryingPhaseRORSum += ror;
                        this.#dryingPhaseAUCSum += deltaAUC;

                        document.getElementById("dryingPhaseStat").innerHTML = "ROR: " + (this.#dryingPhaseRORSum / this.#dryingPhaseCount).toFixed(1) + " AUC: " + (this.#dryingPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#dryEndTime != null) {
                    var maillardPhaseTime = now;
                    if (this.#firstCrackStartTime != null) maillardPhaseTime = this.#firstCrackStartTime;
                    maillardPhaseTime -= this.#dryEndTime;
                    var maillardPhasePercentage = maillardPhaseTime / totalTime * 100.0;
                    maillardPhaseTime /= 1000.0;
                    var maillardPhaseTimeMin = maillardPhaseTime / 60;
                    document.getElementById("maillardPhaseTime").innerHTML = Math.floor(maillardPhaseTimeMin) + ":" + ((maillardPhaseTime) - Math.floor(maillardPhaseTimeMin) * 60).toFixed(1) + " " + maillardPhasePercentage.toFixed(1) + "%";

                    if (this.#firstCrackStartTime == null || (now >= this.#dryEndTime && now <= this.#firstCrackStartTime)) {
                        this.#maillardPhaseCount++;
                        this.#maillardPhaseRORSum += ror;
                        this.#maillardPhaseAUCSum += deltaAUC;

                        document.getElementById("maillardPhaseStat").innerHTML = "ROR: " + (this.#maillardPhaseRORSum / this.#maillardPhaseCount).toFixed(1) + " AUC: " + (this.#maillardPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#firstCrackStartTime != null) {
                    var developmentPhaseTime = now;
                    if (this.#stopTime != null) developmentPhaseTime = this.#stopTime;
                    developmentPhaseTime -= this.#firstCrackStartTime;
                    var developmentPhasePercentage = developmentPhaseTime / totalTime * 100.0;
                    developmentPhaseTime /= 1000.0;
                    var developmentPhaseTimeMin = developmentPhaseTime / 60;
                    document.getElementById("developmentPhaseTime").innerHTML = Math.floor(developmentPhaseTimeMin) + ":" + ((developmentPhaseTime) - Math.floor(developmentPhaseTimeMin) * 60).toFixed(1) + " " + developmentPhasePercentage.toFixed(1) + "%";

                    if (this.#stopTime == null || (now >= this.#firstCrackStartTime && now <= this.#stopTime)) {
                        this.#developmentPhaseCount++;
                        this.#developmentPhaseRORSum += ror;
                        this.#developmentPhaseAUCSum += deltaAUC;

                        document.getElementById("developmentPhaseStat").innerHTML = "ROR: " + (this.#developmentPhaseRORSum / this.#developmentPhaseCount).toFixed(1) + " AUC: " + (this.#developmentPhaseAUCSum).toFixed(1);
                    }
                }

                if (this.#stopTime != null) {
                    var coolingPhaseTime = now;
                    coolingPhaseTime -= this.#stopTime;
                    var coolingPhasePercentage = coolingPhaseTime / totalTime * 100.0;
                    coolingPhaseTime /= 1000.0;
                    var coolingPhaseTimeMin = coolingPhaseTime / 60;
                    document.getElementById("coolingPhaseTime").innerHTML = Math.floor(coolingPhaseTimeMin) + ":" + ((coolingPhaseTime) - Math.floor(coolingPhaseTimeMin) * 60).toFixed(1) + " " + coolingPhasePercentage.toFixed(1) + "%";

                    if(now >= this.#stopTime)
                    {
                        this.#coolingPhaseCount++;
                        this.#coolingPhaseRORSum += ror;
                        this.#coolingPhaseAUCSum += deltaAUC;

                        document.getElementById("coolingPhaseStat").innerHTML = "ROR: " + (this.#coolingPhaseRORSum / this.#coolingPhaseCount).toFixed(1) + " AUC: " + (this.#coolingPhaseAUCSum).toFixed(1);
                    }
                }
            }

            setBeanTemperature(temperature) {
                if (this.#startTime == null) return;

                var now = performance.now();

                this.#beanTemperatures.push([now, temperature]);

                this.#drawBeanTemperature(this.#beanTemperatures.length - 1, now);
            }

            setAirTemperature(temperature) {
                if (this.#startTime == null) return;
                this.#airTemperatures.push([performance.now(), temperature]);
            }

            setExhaustTemperature(temperature) {
                if (this.#startTime == null) return;
                this.#exhaustTemperatures.push([performance.now(), temperature]);
            }

            setName(n) {
                this.#name = n;
            }

            setBeanType(type) {
                this.#beanType = type;
            }

            setMoistureContent(mc) {
                this.#moistureContent = mc;
            }

            setBeanScreenSize(ss) {
                this.#beanScreenSize = ss;
            }

            #calcWeightVolumeDensity() {
                if (this.#weight != null && this.#volume != null && this.#density != null) return;

                if (this.#density != null && this.#volume != null) {
                    this.#weight = this.#density * this.#volume;
                    document.getElementById("beanWeight").value = this.#weight;
                    return;
                }

                if (this.#weight != null && this.#volume != null) {
                    this.#density = this.#weight / this.#volume;
                    document.getElementById("beanDensity").value = this.#density;
                    return;
                }

                if (this.#density != null && this.#weight != null) {
                    this.#volume = this.#weight / this.#density;
                    document.getElementById("beanVolume").value = this.#volume;
                    return;
                }
            }

            #calcEndWeightVolumeDensity() {
                if (this.#endWeight != null && this.#endVolume != null && this.#endDensity != null) return;

                if (this.#endDensity != null && this.#endVolume != null) {
                    this.#endWeight = this.#endDensity * this.#endVolume;
                    document.getElementById("endBeanWeight").value = this.#endWeight;
                    return;
                }

                if (this.#endWeight != null && this.#endVolume != null) {
                    this.#endDensity = this.#endWeight / this.#endVolume;
                    document.getElementById("endBeanDensity").value = this.#endDensity;
                    return;
                }

                if (this.#endDensity != null && this.#endWeight != null) {
                    this.#endVolume = this.#endWeight / this.#endDensity;
                    document.getElementById("endBeanVolume").value = this.#endVolume;
                    return;
                }
            }

            setWeight(bw) {
                if (bw == "") this.#weight = null;
                else {
                    this.#weight = bw;
                    this.#calcWeightVolumeDensity();
                }
            }

            setVolume(bv) {
                if (bv == "" || bv == 0) this.#volume = null;
                else {
                    this.#volume = bv;
                    this.#calcWeightVolumeDensity();
                }
            }

            setDensity(bd) {
                if (bd == "" || bd == 0) this.#density = null;
                else {
                    this.#density = bd;
                    this.#calcWeightVolumeDensity();
                }
            }

            setEndWeight(ew) {
                if (ew == "") this.#endWeight = null;
                else {
                    this.#endWeight = ew;
                    this.#calcEndWeightVolumeDensity();
                }
            }

            setEndVolume(ev) {
                if (ev == "" || ev == 0) this.#endVolume = null;
                else {
                    this.#endVolume = ev;
                    this.#calcEndWeightVolumeDensity();
                }
            }

            setEndDensity(ed) {
                if (ed == "" || ed == 0) this.#endDensity = null;
                else {
                    this.#endDensity = ed;
                    this.#calcEndWeightVolumeDensity();
                }
            }
        }

        function scaleCanvas(canvas, ctx, w, h) {
            // Get the DPR and size of the canvas
            const dpr = window.devicePixelRatio;

            // Set the "actual" size of the canvas
            canvas.width = w * dpr;
            canvas.height = h * dpr;

            // Scale the context to ensure correct drawing operations
            ctx.scale(dpr, dpr);

            // Set the "drawn" size of the canvas
            canvas.style.width = `${w}px`;
            canvas.style.height = `${h}px`;

            return [w, h];
        }

        function lerp(v0, v1, t) {
            return (1 - t) * v0 + t * v1;
        }

        function saturate(x) {
            return Math.min(1.0, Math.max(x, 0.0));
        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function colorRamp(v) {
            v = 2.0 * v;
            r = v - 0.0;
            g = v - 1.0;
            b = v - 2.0;

            r = 1.0 - r * r;
            g = 1.0 - g * g;
            b = 1.0 - b * b;

            r = Math.floor(saturate(r) * 255);
            g = Math.floor(saturate(g) * 255);
            b = Math.floor(saturate(b) * 255);

            return rgbToHex(r, g, b);
        }

        async function pickSaveFile() {
            fileToSave = await window.showSaveFilePicker({
                types: [{
                    description: "JSON file",
                    accept: { "text/plain": [".json"] }
                }]
            });
            var file = await fileToSave.getFile();
            document.getElementById('fileSavePath').value = file.name;
        }

        async function saveRoastProfile() {
            if (fileToSave != null)
            {
                console.log(roastProfile.stringify());
                const fileStream = await fileToSave.createWritable();
                await fileStream.write(new Blob([roastProfile.stringify()], { type: "application/json" }));
                await fileStream.close();
            }
        }

        function loadRoastProfile() {
            if (fileToLoad != null) {
                var reader = new FileReader();
                reader.readAsText(fileToLoad);
                reader.onload = function (evt) {
                    roastProfile = new RoastProfile();
                    roastProfile.parse(reader.result);
                }
            }
        }

        function controlMove(initial, yPos, elem) {
            var curPercentage = elem.firstElementChild.clientHeight / elem.clientHeight;
            var delta = (initial - yPos);
            var percentage = (curPercentage + delta / elem.clientHeight) * 100;

            if (percentage > 100)
                percentage = 100;
            else if (percentage < 0)
                percentage = 0;
            elem.firstElementChild.style = "height: " + percentage + "%;";

            if (elem.getElementsByTagName("img")[0].id == "fanImage") {
                var animLen = 4 - 3.8 * percentage / 100;
                if (percentage == 0) {
                    elem.getElementsByTagName("img")[0].style = "animation: none;";
                }
                else {
                    elem.getElementsByTagName("img")[0].style = "animation: spin " + animLen + "s linear infinite;";
                }
            }

            if (elem.id == "fanController") {
                roastProfile.setFanSpeed(percentage);
            }
            else if (elem.id == "drumController") {
                roastProfile.setDrumSpeed(percentage);
            }
            else if (elem.id == "heaterController") {
                roastProfile.setHeaterSpeed(percentage);
            }

        }

        function controlFunc(e) {
            if (e.type == "mousedown") {
                controllerIsMouseDown = true;
                controllerInitialYPos = e.y;
                controllerClickedElem = this;
            }
            else if (e.type == "touchstart") {
                controllerIsMouseDown = true;
                controllerInitialYPos = e.targetTouches[0].clientY;
                controllerClickedElem = this;
            }
            else if (e.type == "mousemove") {
                if (controllerIsMouseDown) {
                    controlMove(controllerInitialYPos, e.y, controllerClickedElem);
                    controllerInitialYPos = e.y;
                }
            }
            else if (e.type == "touchmove") {
                if (controllerIsMouseDown) {
                    controlMove(controllerInitialYPos, e.targetTouches[0].clientY, controllerClickedElem);
                    controllerInitialYPos = e.targetTouches[0].clientY;
                }
            }
            else if (e.type == "mouseup" || e.type == "touchend") {
                controllerIsMouseDown = false;
            }

            if (controllerIsMouseDown) {
                e.preventDefault();
            }
        }

        function showRoastProperties() {
            document.getElementById('propertiesDialog').style.visibility = "visible";
            document.getElementById('backgroundBlur').style.visibility = "visible";
            document.getElementById('fanImage').style.animationPlayState = "paused";
            updateUI = false;
        }

        function hideRoastProperties() {
            document.getElementById('propertiesDialog').style.visibility = "hidden";
            document.getElementById('backgroundBlur').style.visibility = "hidden";
            document.getElementById('fanImage').style.animationPlayState = "running";
            updateUI = true;
        }

        var temperatureMA = new MovingAverage(100);
        function dummyData(t) {
            //test data for drawing a curve
            var dataSet = [
                22, //minute 0, eg starting
                43, 87, 120, //drying phase
                165, 177, 185, 192, 196, //yellowing, fc
                204, 213, 220, //development
                225, 226, 227, //second crack
                229, 232, 236, 239, 242, 245, //15-20mins
                199, 143, 93, 54, 25 //20-25mins
            ];

            var tMin = t / 60.0;
            var interp = tMin - Math.floor(tMin);
            var val = lerp(dataSet[Math.floor(tMin)], dataSet[Math.ceil(tMin)], interp);
            val = temperatureMA.ma(val);

            roastProfile.setBeanTemperature(val);

            setTimeout(dummyData.bind(null, t + 0.250), 250);
        }
        
        function drawThermalCameraOutput(temperatures) {
            if (updateUI) {
                var canvas = document.getElementById("thermalCamera");
                canvas.style.visibility = "visible";
                canvas.width = 320;
                canvas.height = 240;
                var canvasCtx = canvas.getContext("2d");
                for (x = 0; x < 32; ++x)
                    for (y = 0; y < 24; ++y) {
                        //const randomColor = Math.floor(Math.random() * 16777215).toString(16);
                        //randomTemp = Math.random(); //pretend that it's normalised to 0..1

                        temp = temperatures[32 * (23 - y) + x];
                        //map temperatures to 0..1
                        minTemp = 10.0; //-40c
                        maxTemp = 40.0; //+300c
                        temp = (temp - minTemp) / (maxTemp - minTemp);

                        canvasCtx.fillStyle = colorRamp(1 - temp);
                        canvasCtx.fillRect(x * 10, y * 10, 10, 10);
                    }
            }
        }

        function analyseThermalCameraData(temperatures) {
            var temps = temperatures.slice().sort();
            var min = 300.0;
            var max = -40.0;
            var median = (temps[temps.length / 2] + temps[temps.length / 2 + 1]) / 2.0;
            for (var x of temps) {
                min = Math.min(x, min);
                max = Math.max(x, max);
            }
            document.getElementById("thermalCamMin").innerHTML = min.toFixed(1);
            document.getElementById("thermalCamMax").innerHTML = max.toFixed(1);
            document.getElementById("thermalCamMedian").innerHTML = median.toFixed(1);
        }

        function drawThermalCameraHistogram(temperatures) {
            var histoCanvas = document.getElementById("thermalCamHistogram");
            var histoCtx = histoCanvas.getContext("2d");

            var wh = scaleCanvas(histoCanvas, histoCtx, 300, 150);
            var canvasWidth = wh[0];
            var canvasHeight = wh[1];

            var min = 300.0;
            var max = -40.0;
            for (var x of temperatures) {
                min = Math.min(x, min);
                max = Math.max(x, max);
            }

            var histogram = new Map();
            for (var x = Math.floor(min); x <= Math.floor(max); ++x) {
                histogram.set(x, 0);
            }

            for (var x of temperatures) {
                histogram.set(Math.floor(x), histogram.get(Math.floor(x)) + 1);
            }

            var mostFrequentVal = 0;
            for (const [key, val] of histogram) {
                mostFrequentVal = Math.max(val, mostFrequentVal);
            }

            histoCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            histoCtx.fillStyle = "#555";
            var counter = 0;
            var barwidth = canvasWidth / histogram.size;
            for (const [key, val] of histogram) {
                histoCtx.fillRect(
                    (barwidth) * counter,
                    (1.0 - val / mostFrequentVal) * canvasHeight,
                    barwidth,
                    val / mostFrequentVal * canvasHeight);
                counter++;
            }
        }

        function thermalCamMove(e) {
            var x = Math.floor(e.offsetX / 10.0);
            var y = Math.floor(e.offsetY / 10.0);
            thermalCamSamplePos = 32 * (23 - y) + x;
            document.getElementById("thermalCamTooltip").style.left = e.pageX + 'px';
            document.getElementById("thermalCamTooltip").style.top = e.pageY + 'px';
        }

        function thermalCamTooltipUpdate() {
            if (thermalCamIsMouseIn && thermalCamTemperatures != null) {
                document.getElementById("thermalCamTooltip").innerHTML = thermalCamTemperatures[thermalCamSamplePos].toFixed(1) + " °C";

                setTimeout(thermalCamTooltipUpdate, 30);
            }
        }

        function thermalCamEnter(e) {
            thermalCamIsMouseIn = true;
            if (thermalCamTemperatures != null) {
                document.getElementById("thermalCamTooltip").style.visibility = "visible";
            }

            thermalCamTooltipUpdate();
        }

        function thermalCamLeave(e) {
            thermalCamIsMouseIn = false;
            document.getElementById("thermalCamTooltip").style.visibility = "hidden";
        }

        function connect() {
            try {
                serverURL = document.getElementById("wsAddress").value;
                webSocket = new WebSocket(serverURL);
                webSocket.binaryType = 'arraybuffer';

                webSocket.onerror = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Failed to connect to " + serverURL + "<br>";
                }

                webSocket.onclose = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Connection closed" + "<br>";

                    var tcc = document.getElementById("thermalCamera");
                    var tccCtx = tcc.getContext("2d");
                    tccCtx.clearRect(0, 0, 320, 240);
                    document.getElementById("offlineText").style.visibility = "visible";
                }

                webSocket.onopen = (event) => {
                    document.getElementById("websocketMessages").innerHTML += "Connection opened successfully" + "<br>";
                    //webSocket.send(("a").repeat(65536*2));
                    webSocket.send("hello server!");

                    document.getElementById("offlineText").style.visibility = "hidden";
                }

                webSocket.onmessage = (event) => {
                    //document.getElementById("websocketMessages").innerHTML += "onmessage " + (typeof event.data) + "<br>";
                    if (typeof event.data == "string") {
                        document.getElementById("websocketMessages").innerHTML += event.data + "<br>";
                    }
                    else if (typeof event.data == "object") {
                        arrayBuf = event.data;
                        thermalCamTemperatures = new Float32Array(arrayBuf);
                        drawThermalCameraOutput(thermalCamTemperatures);
                        analyseThermalCameraData(thermalCamTemperatures);
                        drawThermalCameraHistogram(thermalCamTemperatures);
                    }
                }
            }
            catch (error) {
                document.getElementById("websocketMessages").innerHTML += error.message + "<br>";
            }
        }

        function disconnect() {
            if (webSocket != undefined) {
                webSocket.close();
                webSocket = null;
            }
        }

        var fileToLoad = null;
        var fileToSave = null;
        var controllerIsMouseDown = false;
        var controllerInitialYPos = 0.0;
        var controllerClickedElem = undefined;
        var updateUI = true;
        var thermalCamTemperatures = null;
        var thermalCamSamplePos = 0;
        var thermalCamIsMouseIn = false;
        var roastProfile = null;
        var webSocket = null;
        var lineChart = null;

        (function () {
            lineChart = new LineChart(document.getElementById("lineChart"), 1400, 800, 0, 25, 0, 300, 0, 50);
            lineChart.drawLineChartBackground(
                "Time (min)", "Temp °C", "ROR °C/min",
                [5, 10, 15, 20], [50, 100, 150, 200, 250], [10, 20, 30, 40]
            );

            document.addEventListener("mouseup", controlFunc);
            document.addEventListener("mousemove", controlFunc);

            for (c of document.getElementsByClassName("controller")) {
                c.addEventListener("mousedown", controlFunc);

                c.addEventListener("touchstart", controlFunc);
                c.addEventListener("touchend", controlFunc);
                c.addEventListener("touchmove", controlFunc);
            }

            document.getElementById("thermalCamera").addEventListener("mousemove", thermalCamMove);
            document.getElementById("thermalCamera").addEventListener("mouseenter", thermalCamEnter);
            document.getElementById("thermalCamera").addEventListener("mouseleave", thermalCamLeave);

            roastProfile = new RoastProfile();
        })();
    </script>
</body>
</html>
